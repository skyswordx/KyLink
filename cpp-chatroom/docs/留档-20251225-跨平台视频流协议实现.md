# 留档-跨平台视频流协议实现

> **日期**: 2025-12-25  
> **变更范围**: cpp-chatroom 项目  
> **变更类型**: 重大特性开发

---

## 一、变更概述

本次会话完成了跨平台视频流传输功能的完整实现：
- **Phase 2**: UDP视频流协议扩展（帧分包、重组）
- **Phase 3**: RK3566发送端集成（CameraPreviewDialog + VideoStreamer）
- **Phase 4**: Ubuntu接收端实现（VideoPlayerDialog + VideoReceiver）

**实测效果**：FPS约**15帧**，丢帧率**0-3帧**，满足实时视频流需求。

---

## 二、工程演进记录

### 2.1 问题背景

| 阶段 | 内容 |
|------|------|
| **原状** | 校园无线网环境下RK3566的视频流无法传输到Ubuntu端 |
| **需求** | 实现NPU处理后的视频帧通过局域网传输到可视化端 |

### 2.2 技术方案设计

| 设计决策 | 选择 | 理由 |
|----------|------|------|
| **传输协议** | UDP | 实时性优先，丢帧可接受，避免TCP拥塞导致延迟累积 |
| **数据格式** | JPEG | 压缩效率高，兼容性好，简化跨平台实现 |
| **端口分离** | 2426 | 独立于飞秋协议的2425端口，避免冲突 |
| **分包策略** | 1400B | 低于MTU 1500B，避免IP分片 |

### 2.3 实现效果

| 指标 | 实测数据 | 评价 |
|------|----------|------|
| **接收FPS** | ~15 帧/秒 | 流畅 |
| **丢帧率** | 0-3 帧 | 优秀 |
| **编译验证** | 桌面29/RK36模块 | ✅ 通过 |

---

## 三、素材分类

### 亮点箱 ⭐

| 亮点 | 说明 | 代码位置 |
|------|------|----------|
| **UDP帧分包协议** | 自定义8B帧头+1400B载荷，支持大帧拆分重组 | `VideoFrame.h/cpp` |
| **超时帧丢弃机制** | 100ms超时自动丢弃不完整帧，避免内存泄漏 | `VideoReceiver.cpp` |
| **MAC无效过滤优化** | 解决校园网MAC全0导致用户发现失败问题 | `feiqcommu.cpp` |
| **条件编译架构** | 发送端仅RK编译，接收端仅桌面编译 | `CMakeLists.txt` |

**UDP帧头设计**:
```cpp
#pragma pack(push, 1)
struct VideoChunkHeader {
    uint32_t magic;       // VIDEO_FRAME_MAGIC
    uint32_t frameId;     // 帧ID
    uint16_t chunkIndex;  // 分片索引
    uint16_t totalChunks; // 总分片数
    uint32_t payloadSize; // 载荷大小
};
#pragma pack(pop)
```

**帧重组逻辑（伪代码）**:
```
收到UDP包 → 解析帧头 → 按frameId存入缓冲区
→ 检查是否所有分片到齐 → 是则重组JPEG → 解码显示
→ 超时100ms未收齐 → 丢弃该帧
```

### 稳健箱 🛡️

| 改进 | 说明 |
|------|------|
| 帧超时机制 | 防止网络丢包导致内存累积 |
| FPS/丢帧统计 | 实时反馈网络质量 |
| 推流状态UI | 明确显示推流目标和状态 |
| 端口分离 | 视频流2426与控制2425隔离 |

### 债务箱 📝

| 待改进 | 说明 |
|------|------|
| 无ACK机制 | 纯UDP无确认，完全依赖超时丢弃 |
| 无流控 | 发送端无拥塞控制，高丢帧时无自适应 |
| 单播限制 | 目前仅支持点对点传输 |

---

## 四、变更文件清单

### 新增文件

| 文件 | 作用 | 平台 |
|------|------|------|
| `include/video/VideoFrame.h` | UDP帧协议结构 | 通用 |
| `src/video/VideoFrame.cpp` | 帧分包/解析实现 | 通用 |
| `include/video/VideoStreamer.h` | 发送端类声明 | RK3566 |
| `src/video/VideoStreamer.cpp` | UDP发送实现 | RK3566 |
| `include/video/VideoReceiver.h` | 接收端类声明 | 桌面 |
| `src/video/VideoReceiver.cpp` | 帧重组、超时处理 | 桌面 |
| `include/ui/VideoPlayerDialog.h` | 视频接收窗口 | 桌面 |
| `src/ui/VideoPlayerDialog.cpp` | 接收UI实现 | 桌面 |

### 修改文件

| 文件 | 修改内容 |
|------|----------|
| `feiqlib/ipmsg.h` | 添加视频流协议常量 |
| `CMakeLists.txt` | 添加视频模块源文件 |
| `CameraPreviewDialog.h/cpp` | 集成VideoStreamer推流UI |
| `MainWindow.h/cpp` | 添加视频菜单入口(桌面版) |
| `feiqcommu.cpp` | 修复MAC过滤逻辑 |

---

## 五、变更叙事

### Why this?
- 项目需要将RK3566的NPU处理结果可视化展示
- 校园无线网络环境TCP可靠性差，选择UDP优化延迟

### So what?
- 实现了15FPS、0-3丢帧的实时视频流传输
- 两平台独立编译，共享核心协议代码

### What's next?
- 可考虑添加简单流控（动态调整质量）
- 可扩展为组播支持多接收端
- 可集成到聊天窗口实现"视频聊天"功能

---

## 六、使用方法

### RK3566端（发送）

1. 打开摄像头预览窗口
2. 在"推流目标IP"输入框填入Ubuntu的IP地址
3. 点击"开始推流"
4. 状态显示"推流中: x.x.x.x"表示成功

### Ubuntu端（接收）

1. 菜单栏 → 视频 → 打开视频接收窗口
2. 点击"开始接收"
3. 等待RK端开始推流
4. 观察FPS和丢帧统计

---

## 七、性能指标

| 指标 | 数值 | 说明 |
|------|------|------|
| 视频流FPS | ~15 | 接收端实测 |
| 丢帧率 | 0-3 | 校园WiFi环境 |
| 单帧JPEG | ~50KB | 80%质量压缩 |
| 分包数 | ~36 | 50KB/1400B |
| 超时阈值 | 100ms | 帧重组超时 |
