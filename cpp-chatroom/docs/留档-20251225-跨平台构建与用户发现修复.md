# 留档-跨平台构建与用户发现修复

> **日期**: 2025-12-25  
> **变更范围**: cpp-chatroom 项目  
> **变更类型**: 重大特性开发 + 问题修复

---

## 一、变更概述

本次会话完成了两个核心目标：
1. **跨平台构建系统** - 实现 RK3566 与 Ubuntu 桌面双平台条件编译
2. **用户发现 Bug 修复** - 解决校园网环境下两端无法互相发现的问题

---

## 二、工程演进记录

### 2.1 跨平台构建系统

| 阶段 | 内容 |
|------|------|
| **原状/瓶颈** | 原 CMakeLists.txt 硬编码 RK3566 依赖（RKNN/RGA/MPP），Ubuntu 无法编译 |
| **解决策略** | 添加 `BUILD_RK3566` / `BUILD_DESKTOP` 条件编译选项，代码中用 `#ifdef` 隔离平台特有功能 |
| **改进效果** | 两平台均可独立编译，共享核心通信代码 |

**验证结果**:
- ✅ RK3566 交叉编译: 34/34 模块
- ✅ Ubuntu 桌面编译: 26/26 模块

### 2.2 用户发现 Bug 修复

| 阶段 | 内容 |
|------|------|
| **原状/瓶颈** | 校园无线网下 RK↔Ubuntu 无法互相发现上线 |
| **问题诊断** | `tcpdump` 确认 UDP 广播包能收到，但应用层过滤 → MAC 地址获取失败返回 `"000000000000"`，导致误判为自己的包 |
| **解决策略** | 改进 `isValidMac()` 判断：空字符串或全0均视为无效 MAC，不过滤 |
| **改进效果** | 两端正常互相发现 |

---

## 三、素材分类

### 亮点箱 ⭐

| 亮点 | 说明 | 代码位置 |
|------|------|----------|
| **条件编译架构** | 用 CMake 选项 + `#ifdef` 宏实现平台隔离，共享 `feiqlib/` 核心代码 | `CMakeLists.txt` |
| **自动网络发现** | 启动时自动枚举所有网络接口广播地址，适应多网卡环境 | `MainWindow.cpp` |
| **定期用户广播** | 每10秒重发上线广播，提高无线网络稳定性 | `FeiqBackend::enableIntervalDetect()` |
| **MAC 有效性判断** | Lambda 函数判断 MAC 是否有效（非空且非全0） | `feiqcommu.cpp` |

**代码片段（MAC 有效性判断）**:
```cpp
auto isValidMac = [](const std::string& mac) {
    if (mac.empty()) return false;
    for (char c : mac) {
        if (c != '0') return true;
    }
    return false;
};
```

### 稳健箱 🛡️

| 改进 | 说明 |
|------|------|
| MAC 无效时不过滤 | 宁可漏过自己的包也不误杀别人的包 |
| GNUmakefile wrapper | 简化构建命令，降低使用门槛 |
| BUILD_GUIDE.md | 详细构建文档，方便后续维护 |

### 债务箱 📝

| 待改进 | 说明 |
|------|------|
| MAC 获取失败根因 | 未深入分析为何 Linux 下获取 MAC 返回全0，可能是接口选择问题 |
| 视频流功能 | 跨平台视频流传输尚未实现（Phase 2-5） |
| 测试覆盖 | 无自动化测试验证条件编译的两个分支 |

---

## 四、变更文件清单

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `CMakeLists.txt` | 重写 | 添加条件编译选项 |
| `GNUmakefile` | 新增 | 构建命令 wrapper |
| `BUILD_GUIDE.md` | 新增 | 跨平台构建文档 |
| `include/ui/MainWindow.h` | 修改 | 条件编译 PerformanceAnalyticsDialog |
| `src/ui/MainWindow.cpp` | 修改 | 自动获取广播地址 + 定期检测 |
| `include/ui/ChatWindow.h` | 修改 | 条件编译摄像头/截图 |
| `src/ui/ChatWindow.cpp` | 修改 | 条件编译摄像头/截图实现 |
| `src/app/main.cpp` | 修改 | 条件编译 NPU/RGA 自检 |
| `include/backend/FeiqBackend.h` | 修改 | 添加 enableIntervalDetect() |
| `src/backend/FeiqBackend.cpp` | 修改 | 实现 enableIntervalDetect() |
| `feiqlib/feiqcommu.cpp` | 修改 | 修复 MAC 判断逻辑 |

---

## 五、变更叙事

### Why this?
- 项目需要在 RK3566 嵌入式平台和 Ubuntu 桌面同时运行
- 校园无线网络环境导致 MAC 地址获取异常，需要健壮的用户发现机制

### So what?
- 一套代码，两平台编译，降低维护成本
- 用户发现问题从"完全不可用"到"稳定可用"

### What's next?
- 实现跨平台视频流传输（UDP 帧传输）
- 深入排查 MAC 获取失败的根因
- 添加条件编译的自动化测试

---

## 六、使用指南

```bash
# 桌面版构建
make desktop

# RK3566 交叉编译
source env/setup-rk3566.sh
make rk3566

# 查看帮助
make help
```
