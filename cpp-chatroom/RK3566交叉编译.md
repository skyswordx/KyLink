## äº¤å‰ç¼–è¯‘å‡†å¤‡æŒ‡å—

æœ¬æŒ‡å—å¸®åŠ©ä½ åœ¨ **WSL ç¯å¢ƒ** ä¸­åŒæ—¶ä¸ºä¸¤ç±»ç›®æ ‡å¹³å°å‡†å¤‡äº¤å‰ç¼–è¯‘ç¯å¢ƒï¼š

- Windows 10/11 x64
- RK3566ï¼ˆKylin Ubuntuï¼‰

### 3. é¢å‘ RK3566ï¼ˆKylin Ubuntuï¼‰

#### 3.1 æ“ä½œæ€»è§ˆ

- æ¿ç«¯ç¡®è®¤ Qt è¿è¡Œåº“å®Œæ•´ï¼Œå¹¶å¯¼å‡ºåŒ¹é…çš„ sysrootã€‚
- åœ¨ WSL å‡†å¤‡äº¤å‰å·¥å…·é“¾ã€è§£å‹ sysrootï¼Œè¡¥å…… Qt CMake é…ç½®ä¸ glibc startfilesã€‚
- æ ¹æ®éœ€è¦ï¼ˆå¤ç”¨æˆ–è‡ªå»ºï¼‰å‡†å¤‡ Qt 5.12.8 aarch64ã€‚
- ä½¿ç”¨å·¥å…·é“¾æ–‡ä»¶é…ç½® CMakeï¼Œç”Ÿæˆ `FeiQChatroom` çš„ aarch64 å¯æ‰§è¡Œæ–‡ä»¶ã€‚
- å›ä¼ å¯æ‰§è¡Œæ–‡ä»¶åŠä¾èµ–åº“åˆ°æ¿ç«¯éªŒè¯è¿è¡Œã€‚

#### 3.2 æ¿ç«¯å‡†å¤‡

**Qt è¿è¡Œåº“æ ¸å¯¹**

- `ldconfig -p | grep Qt5`ï¼šç¡®è®¤ `libQt5Core.so.5`ã€`libQt5Gui.so.5`ã€`libQt5Widgets.so.5`ã€`libQt5Network.so.5` å‡å­˜åœ¨ã€‚
- å¦‚ç¼ºå¤±ï¼Œå¯å®‰è£…å‘è¡Œç‰ˆè¿è¡Œæ—¶åŒ…ï¼ˆç¤ºä¾‹ï¼‰` sudo apt install libqt5core5a libqt5gui5 libqt5widgets5 libqt5network5`
- `qmake -v` æˆ– `strings libQt5Core.so.5 | grep "Qt "` æ£€æŸ¥ç‰ˆæœ¬ï¼›`ls -l /usr/lib/aarch64-linux-gnu/libQt5Core.so*` æ ¡éªŒç¬¦å·é“¾æ¥ã€‚
- `ldd /opt/feiqlab/FeiQChatroom | grep Qt5` å¯éªŒè¯å·²æœ‰ç¨‹åºè¿è¡Œä¾èµ–ã€‚

**é‡‡é›† sysroot**

- **æ— ç½‘ç»œ**ï¼šåœ¨æ¿ç«¯æ‰§è¡Œ

  ```bash
  sudo tar -cpf /tmp/rk3566-sysroot-$(date +%Y%m%d).tar \
      --numeric-owner --xattrs --acls \
      -C / \
      usr lib etc/ld.so.conf etc/ld.so.conf.d etc/ld.so.cache
  ```

  å°† tar åŒ…æ‹·è´åˆ° U ç›˜ï¼Œè¿åŒæ ¡éªŒå€¼ `sha256sum /tmp/rk3566-sysroot-*.tar`ã€‚
- **æœ‰ç½‘ç»œ**ï¼š`rsync -a root@<board-ip>:/usr/ ...`ã€`rsync -a root@<board-ip>:/lib/ ...`ã€‚
- **å¤ç”¨ SDK é•œåƒ**ï¼š

  1. åˆ›å»ºæŒ‚è½½ç‚¹ä¸ç›®æ ‡ç›®å½•

  ```bash
  mkdir -p /home/circlemoon/sysroots/rk3566-rootfs-mnt
  mkdir -p /home/circlemoon/sysroots/rk3566
  ```

  2. æŒ‚è½½ rootfs é•œåƒ

  ```bash
  sudo mount -o loop \
    /home/circlemoon/SDK/firefly_rk3588_SDK/prebuilt_rootfs/Ubuntu20.04.3LTS_Firefly_202510071336_rootfs.img \
    /home/circlemoon/sysroots/rk3566-rootfs-mnt
  ```

  3. åŒæ­¥å†…å®¹åˆ° sysroot

  ```bash
  sudo rsync -aHAX --delete \
    /home/circlemoon/sysroots/rk3566-rootfs-mnt/ \
    /home/circlemoon/sysroots/rk3566/
  ```

  4. å¸è½½é•œåƒå¹¶æ¸…ç†æŒ‚è½½ç‚¹

  ```bash
  sudo umount /home/circlemoon/sysroots/rk3566-rootfs-mnt
  rmdir /home/circlemoon/sysroots/rk3566-rootfs-mnt
  ```

> âš ï¸ è¯·ç¡®ä¿åŒæ­¥æ—¶åŒ…å« `/usr/lib/aarch64-linux-gnu/cmake/Qt5*`ã€`/usr/lib/aarch64-linux-gnu/crt*.o` ç­‰å…³é”®æ–‡ä»¶ã€‚

#### 3.3 WSL ç«¯å‡†å¤‡

**å®‰è£…å·¥å…·é“¾ä¸å¸¸ç”¨å·¥å…·**

```bash
sudo apt update
sudo apt install build-essential cmake ninja-build pkg-config rsync \
    gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
```

> ğŸ“Œ å®æµ‹ Firefly SDK è‡ªå¸¦çš„ `aarch64-none-linux-gnu-g++` ä¾èµ– glibc 2.33ï¼Œä¼šä¸æ¿ç«¯ 2.31 å†²çªå¹¶è§¦å‘ `GLIBC_2.33` é“¾æ¥é”™è¯¯ã€‚æœ¬æµç¨‹ç»Ÿä¸€ä½¿ç”¨ç³»ç»Ÿäº¤å‰ç¼–è¯‘å™¨ï¼ˆ9.3/9.4ï¼‰ã€‚

**å¯¼å…¥ sysroot**

```bash
sudo mkdir -p /opt/rk3566-sysroot
cd /opt/rk3566-sysroot
sudo tar -xpf /mnt/d/exports/rk3566-sysroot-*.tar   # æ ¹æ®å®é™…è·¯å¾„æ›¿æ¢
```

åŒæ­¥å®Œæˆåï¼š

- `ls -l usr/lib/aarch64-linux-gnu/libQt5Core.so*`ã€`libQt5Gui.so*` æ£€æŸ¥ Qt åº“ã€‚
- è‹¥ `cmake/Qt5` ç›®å½•ç¼ºå¤±ï¼Œä»æ¿ç«¯æˆ–é•œåƒå•ç‹¬ `rsync` è¿‡æ¥ã€‚
- å¦‚æœé“¾æ¥æ—¶æŠ¥ `crt1.o`/`crti.o` ç¼ºå¤±ï¼Œç¡®è®¤ `usr/lib/aarch64-linux-gnu/crt*.o` å­˜åœ¨ï¼Œå¹¶æ‰§è¡Œï¼š
  ```bash
  sudo cp usr/lib/aarch64-linux-gnu/crt*.o usr/lib/
  sudo ln -s aarch64-linux-gnu usr/lib/aarch64-none-linux-gnu
  ```

**ç¯å¢ƒè„šæœ¬**ï¼ˆ`env/setup-rk3566.sh`ï¼‰

```bash
#!/bin/bash
export RK3566_SDK=/home/circlemoon/SDK/firefly_rk3588_SDK
export RK3566_TOOLCHAIN=/usr
export RK3566_PREFIX=aarch64-linux-gnu
export RK3566_SYSROOT=/home/circlemoon/sysroots/rk3566

export PATH=/usr/bin:$PATH
export PKG_CONFIG_SYSROOT_DIR=$RK3566_SYSROOT
export PKG_CONFIG_LIBDIR=$RK3566_SYSROOT/usr/lib/pkgconfig:\
    $RK3566_SYSROOT/usr/share/pkgconfig:\
    $RK3566_SYSROOT/usr/lib/aarch64-linux-gnu/pkgconfig
```

ä½¿ç”¨å‰æ‰§è¡Œ `source env/setup-rk3566.sh`ã€‚

#### 3.4 CMake å·¥å…·é“¾æ–‡ä»¶

`cmake/toolchains/rk3566.cmake`

```cmake
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR aarch64)

if(NOT DEFINED ENV{RK3566_SYSROOT})
  message(FATAL_ERROR "è¯·å…ˆ source env/setup-rk3566.sh")
endif()

set(RK3566_SYSROOT $ENV{RK3566_SYSROOT})
if(DEFINED ENV{RK3566_PREFIX})
  set(RK3566_PREFIX $ENV{RK3566_PREFIX})
else()
  set(RK3566_PREFIX aarch64-linux-gnu)
endif()

set(CMAKE_SYSROOT ${RK3566_SYSROOT})
set(CMAKE_C_COMPILER ${RK3566_PREFIX}-gcc)
set(CMAKE_CXX_COMPILER ${RK3566_PREFIX}-g++)

set(CMAKE_C_FLAGS_INIT "--sysroot=${CMAKE_SYSROOT}")
set(CMAKE_CXX_FLAGS_INIT "--sysroot=${CMAKE_SYSROOT}")

set(CMAKE_FIND_ROOT_PATH ${CMAKE_SYSROOT})
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
```

#### 3.5 Qt å¯ç”¨æ€§

- **å¤ç”¨æ¿ç«¯ Qt**ï¼šç¡®ä¿ sysroot åŒ…å« `Qt5Config.cmake`ï¼Œå¹¶å°† `CMAKE_PREFIX_PATH` æŒ‡å‘ `â€¦/usr/lib/aarch64-linux-gnu/cmake`ã€‚
- **è‡ªè¡Œäº¤å‰ç¼–è¯‘**ï¼ˆå¯é€‰ï¼‰ï¼šæŒ‰éœ€åœ¨ WSL å†…å¯¹ Qt 5.12.8 æºç æ‰§è¡Œ
  ```bash
  /opt/qt-src-5.12.8/configure \
      -prefix /opt/qt-5.12.8-rk3566 \
      -opensource -confirm-license \
      -release \
      -platform linux-g++-64 \
      -device-option CROSS_COMPILE=aarch64-linux-gnu- \
      -sysroot /opt/rk3566-sysroot \
      -nomake tests -nomake examples \
      -skip qtwebengine
  ```

  ç¼–è¯‘ååœ¨ `CMAKE_PREFIX_PATH` ä¸­ä½¿ç”¨ `/opt/qt-5.12.8-rk3566/lib/cmake/Qt5`ã€‚

å¦‚æœå‡ºç°æŠ¥é”™å°±æ˜¯å› ä¸ºå½“å‰ sysroot é‡Œç¼ºå°‘ Qt çš„ CMake é…ç½®ï¼ˆ`Qt5Config.cmake` ç­‰ï¼‰ã€‚æ—¢ç„¶æ¿å­ä¸Šåæ¥æ‰å®‰è£…äº† `qmake/qtbase5-dev`ï¼ŒåŸå…ˆæå–çš„ rootfs é‡Œè‚¯å®šæ²¡æœ‰è¿™äº›æ–‡ä»¶ã€‚æ— éœ€é‡æ–°æ‹·å®Œæ•´ä¸ª sysrootï¼Œåªè¦æŠŠ Qt ç›¸å…³çš„ â€œå¼€å‘â€ éƒ¨åˆ†è¡¥é½å³å¯ã€‚

æ¿ç«¯æ“ä½œ

1. åœ¨æ¿å­ä¸Šä¸´æ—¶æ”¶é›†è¦åŒæ­¥çš„ç›®å½•ï¼ˆåŒ…å« CMake é…ç½®ã€åº“ã€å¤´æ–‡ä»¶ã€pkg-config ä»¥åŠ mkspecsï¼‰ï¼š

   ```bash
   sudo mkdir -p /tmp/qt5-dev-sync/usr/lib/aarch64-linux-gnu/cmake
   sudo mkdir -p /tmp/qt5-dev-sync/usr/lib/aarch64-linux-gnu/pkgconfig
   sudo mkdir -p /tmp/qt5-dev-sync/usr/lib/qt5
   sudo mkdir -p /tmp/qt5-dev-sync/usr/include

   sudo rsync -a /usr/lib/aarch64-linux-gnu/cmake/Qt5* /tmp/qt5-dev-sync/usr/lib/aarch64-linux-gnu/cmake/
   sudo rsync -a /usr/lib/aarch64-linux-gnu/libQt5*.so* /tmp/qt5-dev-sync/usr/lib/aarch64-linux-gnu/
   sudo rsync -a /usr/lib/aarch64-linux-gnu/pkgconfig/Qt5*.pc /tmp/qt5-dev-sync/usr/lib/aarch64-linux-gnu/pkgconfig/
   sudo rsync -a /usr/include/qt5 /tmp/qt5-dev-sync/usr/include/
   sudo rsync -a /usr/lib/qt5/mkspecs /tmp/qt5-dev-sync/usr/lib/qt5/
   ```
2. æ‰“åŒ…æ–¹ä¾¿æ‹·è´ï¼š

   ```bash
   sudo tar -cpf /tmp/qt5-rk3566-dev.tar \
       --numeric-owner --xattrs --acls \
       -C /tmp/qt5-dev-sync .
   ```
3. å°† `/tmp/qt5-rk3566-dev.tar` å¤åˆ¶åˆ° U ç›˜æˆ–å…¶ä»–ä»‹è´¨ï¼ˆå¦‚æœæœ‰ SSHï¼Œä¹Ÿå¯ä»¥ç”¨ `scp`ï¼‰ã€‚



WSLï¼šåˆå…¥ç°æœ‰ sysroot

1. æ‹·è´ tar åŒ…åˆ° WSL åï¼Œè§£åŒ…åˆ° sysroot æ ¹ç›®å½•ï¼ˆå‡è®¾ä»åœ¨ `/opt/rk3566-sysroot`ï¼‰ï¼š

   ```bash
   sudo tar -xpf /mnt/d/qt5-rk3566-dev.tar -C /opt/rk3566-sysroot
   ```
2. éªŒè¯é…ç½®æ–‡ä»¶å·²ç»åˆ°ä½ï¼š

   ```bash
   find /opt/rk3566-sysroot -name Qt5Config.cmake
   ```

   çœ‹åˆ°è¯¸å¦‚ `/opt/rk3566-sysroot/usr/lib/aarch64-linux-gnu/cmake/Qt5/Qt5Config.cmake` å°±è¯´æ˜æˆåŠŸã€‚
3. å†æ¬¡æ‰§è¡Œæ„å»ºï¼ˆç¡®ä¿ `CMAKE_PREFIX_PATH` æŒ‡å‘åŒ…å« Qt é…ç½®çš„ç›®å½•ï¼‰ï¼š

   ```bash
   source env/setup-rk3566.sh
   cmake -S . -B build-rk3566 -G Ninja \
         -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/rk3566.cmake \
         -DCMAKE_PREFIX_PATH=$RK3566_SYSROOT/usr/lib/aarch64-linux-gnu/cmake \
         -DCMAKE_BUILD_TYPE=Release
   cmake --build build-rk3566 --parallel
   ```



å¤‡é€‰æ–¹æ¡ˆï¼ˆå…æ‰‹åŠ¨æ‹·è´ï¼‰

å¦‚æœä½ æ„¿æ„åœ¨ WSL ä¸Šå¯ç”¨ `arm64` åŒ…ä»“åº“ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å®‰è£… `qtbase5-dev:arm64`ã€`qt5-qmake:arm64` ç­‰å¼€å‘åŒ…ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨æŠŠè¿™äº›æ–‡ä»¶æ”¾è¿› aarch64-linux-gnu ä¸‹ã€‚ä½†éœ€è¦é…ç½®å¤šæ¶æ„æºï¼Œå¯¹ç¯å¢ƒè¦æ±‚ç¨é«˜ã€‚

---

æŒ‰ä¸Šé¢ â€œç²¾é€‰æ‹·è´â€ çš„æ–¹å¼ï¼Œä½ åªéœ€åŒæ­¥ Qt çš„å¼€å‘å­é›†å³å¯ï¼Œè®© `find_package(Qt5 ...)` èƒ½å¤Ÿæ‰¾åˆ° `Qt5Config.cmake`ã€å¯¹åº”åº“ã€å¤´æ–‡ä»¶å’Œ pkg-config é…ç½®ï¼Œåç»­äº¤å‰ç¼–è¯‘å°±ä¸ä¼šå†å¡åœ¨ç¼ºæ–‡ä»¶çš„é—®é¢˜ä¸Šã€‚

#### 3.6 é¡¹ç›®äº¤å‰ç¼–è¯‘

```bash
source env/setup-rk3566.sh
cmake -S /home/circlemoon/kylin/cpp-chatroom \
      -B /home/circlemoon/kylin/cpp-chatroom/build-rk3566 \
      -G "Ninja" \
      -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/rk3566.cmake \
      -DCMAKE_PREFIX_PATH=$RK3566_SYSROOT/usr/lib/aarch64-linux-gnu/cmake \
      -DCMAKE_BUILD_TYPE=Release

cmake --build /home/circlemoon/kylin/cpp-chatroom/build-rk3566 --parallel
```

å®Œæˆåç”¨ `file build-rk3566/bin/FeiQChatroom` ç¡®è®¤ç›®æ ‡æ¶æ„ï¼Œå¹¶å¯ `tar -cpf build-rk3566.tar -C build-rk3566 bin lib` ä»¥ä¾¿ä¼ è¾“ã€‚

#### 3.7 è¿è¡Œä¸éªŒè¯

- å°†äºŒè¿›åˆ¶ä¸ä¾èµ–åº“æ‹·è´å›æ¿ç«¯ï¼›è‹¥ä½¿ç”¨è‡ªå»º Qtï¼Œéœ€è¦ä¸€å¹¶éƒ¨ç½² `/opt/qt-5.12.8-rk3566`ã€‚
- æ¿ç«¯è¿è¡Œï¼š
  ```bash
  export LD_LIBRARY_PATH=/opt/qt-5.12.8-rk3566/lib:$LD_LIBRARY_PATH
  export QT_QPA_PLATFORM=linuxfb   # æˆ– wayland/xcbï¼Œè§†ç¯å¢ƒè€Œå®š
  /opt/feiqlab/FeiQChatroom
  ```
- `ldd /opt/feiqlab/FeiQChatroom` å¯å¤æ ¸ä¾èµ–è§£ææƒ…å†µã€‚

#### 3.8 å¸¸è§é—®é¢˜

- **å¤´æ–‡ä»¶ç¼ºå¤± / pkg-config æŠ¥é”™**ï¼šæ£€æŸ¥ sysroot ä¸­çš„ `usr/include` ä¸ `pkgconfig` ç›®å½•æ˜¯å¦å®Œæ•´ï¼Œå¿…è¦æ—¶é‡æ–°åŒæ­¥ã€‚
- **GLIBC ç‰ˆæœ¬ä¸åŒ¹é…**ï¼šä½¿ç”¨ç³»ç»Ÿ `gcc-aarch64-linux-gnu`ï¼›è‹¥å¿…é¡»ä½¿ç”¨ SDK å·¥å…·é“¾ï¼Œåˆ™éœ€åŒæ­¥å…¶é…å¥— libcã€‚ï¼ˆå­˜åœ¨å‡çº§æ¿ç«¯ç³»ç»Ÿé£é™©ï¼Œè¯·è°¨æ…ã€‚ï¼‰
- **Qt CMake æ–‡ä»¶ç¼ºå¤±**ï¼šè¡¥é½ `usr/lib/aarch64-linux-gnu/cmake/Qt5*`ï¼Œæˆ–æ”¹ç”¨è‡ªè¡Œäº¤å‰ç¼–è¯‘çš„ Qtã€‚
- **crt1.o / crti.o æœªæ‰¾åˆ°**ï¼šæŒ‰ 3.3 ä¸­æ­¥éª¤å¤åˆ¶ startfilesï¼Œç¡®ä¿ `aarch64-none-linux-gnu` è½¯é“¾æ¥å­˜åœ¨ã€‚
- **è¿è¡Œæ—¶åº“ç¼ºå¤±**ï¼šåœ¨æ¿ç«¯æ‰§è¡Œ `ldd` æŸ¥æ¼è¡¥ç¼ºï¼ŒæŠŠç¼ºå°‘çš„ `.so` æ–‡ä»¶æ”¾å…¥åº”ç”¨å¯è®¿é—®çš„ç›®å½•ï¼ˆå¸¸ç”¨ `/opt/feiqlab/lib`ï¼‰ã€‚
- **Qt æ¨¡å—éœ€æ±‚**ï¼šå½“å‰é¡¹ç›®åªé“¾æ¥ `Core`/`Gui`/`Widgets`/`Network`ã€‚å¦‚åç»­ä½¿ç”¨ `Qt Charts`ã€`Svg`ã€`Multimedia` ç­‰æ¨¡å—ï¼Œéœ€è¦åŒæ­¥å¯¹åº”è¿è¡Œåº“å’Œ `*-dev` åŒ…ã€‚

### 4. éªŒè¯æµç¨‹å»ºè®®

- **ç‰ˆæœ¬ä¸€è‡´æ€§**ï¼šä¿æŒä¸»æœºã€Windowsã€RK3566 ä¸Š Qt ä¸»ç‰ˆæœ¬ä¸€è‡´ï¼ˆ5.12.xï¼‰ï¼Œå‡å°‘ ABI å·®å¼‚ã€‚
- **æ„å»ºç¼“å­˜**ï¼šä¸åŒç›®æ ‡ä½¿ç”¨å„è‡ªçš„æ„å»ºç¼“å­˜ç›®å½•ï¼Œé¿å…äº¤å‰æ±¡æŸ“ã€‚
- **æ—¥å¿—è®°å½•**ï¼šå°†æ¯æ¬¡ configure çš„å‚æ•°å†™å…¥è„šæœ¬æˆ– Markdownï¼Œæ–¹ä¾¿æ’æŸ¥ã€‚
- **éƒ¨ç½²æµ‹è¯•**ï¼š
  - Windowsï¼šåœ¨åŸç”Ÿ Windows ç¯å¢ƒè¿è¡Œ `FeiQChatroom.exe` å¹¶éªŒè¯ `windeployqt` ç»“æœã€‚
  - RK3566ï¼šæ£€æŸ¥ç½‘ç»œé…ç½®ã€æ˜¾ç¤ºåç«¯ï¼ˆFBã€Waylandã€X11ï¼‰æ˜¯å¦åŒ¹é…åº”ç”¨è®¾ç½®ã€‚

é€šè¿‡ä¸Šè¿°å‡†å¤‡ï¼Œå³å¯åœ¨ WSL ä¸­é«˜æ•ˆå®Œæˆé¢å‘ Windows x64 ä¸ RK3566 Kylin Ubuntu çš„äº¤å‰ç¼–è¯‘ã€‚
