## 首先是 gstreamer & opencv3.4.15 & librknnrt.so

无网络环境的版本
创建打包内容并生成 tar（先把 HOST_SYSROOT、USB_MOUNT、BUNDLE 按实际路径调整）

注意 file 一下文件确保不是坏链，小心只复制了符号链接
```bash
set -e
export HOST_SYSROOT=/home/circlemoon/sysroots/rk3566
export STAGING=/home/circlemoon/exports/opencv-rknn-bundle
export USB_MOUNT=/media/$USER/USB   # 改成你的 U 盘挂载点
export BUNDLE=/home/circlemoon/exports/opencv-rknn-rk3566-$(date +%Y%m%d).tar

rm -rf "$STAGING"
mkdir -p "$STAGING"/{opencv/lib,opencv/share,rknn/lib,rknn/include}

rsync -a "$HOST_SYSROOT"/usr/lib/libopencv_{core,imgproc,imgcodecs,videoio,highgui}.so* "$STAGING/opencv/lib/"
rsync -a "$HOST_SYSROOT"/usr/share/OpenCV "$STAGING/opencv/share/"
rsync -a "$HOST_SYSROOT"/usr/lib/pkgconfig/opencv.pc "$STAGING/opencv/"

rsync -aL "$HOST_SYSROOT"/usr/lib/librknnrt.so* "$STAGING/rknn/lib/"
rsync -a "$HOST_SYSROOT"/usr/include/rknn "$STAGING/rknn/include/"

tar -C "$STAGING" -cpf "$BUNDLE" .
cp "$BUNDLE" "$USB_MOUNT/"
sync
```
板端离线部署（U 盘插入后执行）
假设 U 盘挂载到 /media/<user>/USB，选择一个临时目录解压：
```bash
set -e
export USB_MOUNT=/media/$USER/USB
export STAGING=/opt/rk3566-sync

sudo mkdir -p "$STAGING"
sudo tar -xpf "$USB_MOUNT/opencv-rknn-rk3566-YYYYMMDD.tar" -C "$STAGING"   # 日期按实际文件名替换

echo '/usr/local/lib' | sudo tee /etc/ld.so.conf.d/local-opencv-rknn.conf >/dev/null
sudo rsync -a "$STAGING/opencv/lib/" /usr/local/lib/
sudo rsync -a "$STAGING/opencv/share/" /usr/local/share/
sudo install -m 644 "$STAGING/opencv/opencv.pc" /usr/local/lib/pkgconfig/opencv.pc
sudo rsync -a "$STAGING/rknn/lib/" /usr/local/lib/
sudo rsync -a "$STAGING/rknn/include/" /usr/local/include/

sudo ldconfig
ldconfig -p | grep -E 'opencv|rknn'
```

## 新版 rga 库

开发机（WSL/Ubuntu）打包新版 RGA 运行时和头文件，依旧先设置路径并强制展开符号链接：
```bash
set -e
export HOST_SYSROOT=/home/circlemoon/sysroots/rk3566
export STAGING=/home/circlemoon/exports/rga-bundle
export USB_MOUNT=/media/$USER/USB
export BUNDLE=/home/circlemoon/exports/rga-rk3566-$(date +%Y%m%d).tar

rm -rf "$STAGING"
mkdir -p "$STAGING"/rga/{lib,include,pkgconfig}

rsync -a "$HOST_SYSROOT"/usr/lib/aarch64-linux-gnu/librga.so* "$STAGING/rga/lib/"   # 保留 .so -> .so.2.1.0 的符号链接
rsync -a "$HOST_SYSROOT"/usr/include/rga/ "$STAGING/rga/include/"
install -m 644 "$HOST_SYSROOT"/usr/lib/pkgconfig/rga.pc "$STAGING/rga/pkgconfig/rga.pc"

tar -C "$STAGING" -cpf "$BUNDLE" .
cp "$BUNDLE" "$USB_MOUNT/"
sync
```

板端离线部署（插好 U 盘后一条条执行）。建议先备份系统自带 librga，方便回滚：
```bash
set -e
export USB_MOUNT=/media/$USER/USB
export STAGING=/opt/rk3566-sync

sudo mkdir -p "$STAGING"
sudo tar -xpf "$USB_MOUNT/rga-rk3566-YYYYMMDD.tar" -C "$STAGING"   # 与实际文件名保持一致

sudo cp -a /lib/aarch64-linux-gnu/librga.so /lib/aarch64-linux-gnu/librga.so.bak
sudo cp -a /lib/aarch64-linux-gnu/librga.so.2 /lib/aarch64-linux-gnu/librga.so.2.bak

echo '/usr/local/lib' | sudo tee /etc/ld.so.conf.d/local-rga.conf >/dev/null
sudo rsync -a "$STAGING/rga/lib/" /usr/local/lib/
sudo mkdir -p /usr/local/include/rga
sudo rsync -a "$STAGING/rga/include/" /usr/local/include/rga/
sudo mkdir -p /usr/local/lib/pkgconfig
sudo install -m 644 "$STAGING/rga/pkgconfig/rga.pc" /usr/local/lib/pkgconfig/rga.pc

sudo ldconfig
ldconfig -p | grep librga || true
nm -D /usr/local/lib/librga.so | grep imcopy
```

若需临时恢复旧版本，删掉 `/usr/local/lib/librga.so*` 并用备份覆盖，再次 `sudo ldconfig` 即可。

你现在的 FeiQChatroom 还是在加载旧版库：ldconfig -p 只说明两个路径都可用，但不会告诉动态链接器实际挑了哪一个。先跑一次 ldd ./FeiQChatroom | grep rga 看看显示的是 /lib/... 还是 /usr/local/...。如果仍是 lib，说明 RUNPATH/默认优先级把系统库排在前面。最简单的办法是暂时把旧库挪走：
```bash
sudo mv /lib/aarch64-linux-gnu/librga.so /lib/aarch64-linux-gnu/librga.so.disable
sudo mv /lib/aarch64-linux-gnu/librga.so.2 /lib/aarch64-linux-gnu/librga.so.2.disable
sudo ldconfig
ldd ./FeiQChatroom | grep rga
```12
这样可以强制程序只能加载 lib 版本


## 然后是 my_kylin_led_driver.ko & dtb

