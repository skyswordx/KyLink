# Kylin Messenger é¡¹ç›®æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆä¸é€‰å‹](#æŠ€æœ¯æ ˆä¸é€‰å‹)
3. [é¡¹ç›®æ¶æ„](#é¡¹ç›®æ¶æ„)
4. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
5. [åŠŸèƒ½å®ç°ç»†èŠ‚](#åŠŸèƒ½å®ç°ç»†èŠ‚)
6. [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
8. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®ç®€ä»‹
**Kylin Messenger** æ˜¯ä¸€ä¸ªåŸºäº PyQt5 å’Œ Fluent Design è®¾è®¡è¯­è¨€çš„ç°ä»£åŒ–å±€åŸŸç½‘å³æ—¶é€šè®¯å·¥å…·ã€‚é¡¹ç›®çµæ„Ÿæ¥æºäºç»å…¸çš„ FeiQï¼ˆé£ç§‹ï¼‰ï¼Œæ—¨åœ¨å®ç°ä¸€ä¸ªæ— éœ€æœåŠ¡å™¨ã€è·¨å¹³å°çš„å±€åŸŸç½‘èŠå¤©è§£å†³æ–¹æ¡ˆã€‚

### æ ¸å¿ƒç‰¹æ€§
- âœ… **å±€åŸŸç½‘ç”¨æˆ·è‡ªåŠ¨å‘ç°** - åŸºäº UDP å¹¿æ’­æœºåˆ¶
- âœ… **ä¸€å¯¹ä¸€èŠå¤©** - æ”¯æŒæ–‡æœ¬ã€è¡¨æƒ…ã€å›¾ç‰‡æ¶ˆæ¯
- âœ… **ç¾¤ç»„èŠå¤©** - æ”¯æŒå‘åˆ†ç»„å†…æ‰€æœ‰æˆå‘˜ç¾¤å‘æ¶ˆæ¯
- âœ… **æ–‡ä»¶ä¼ è¾“** - TCP å¯é ä¼ è¾“ï¼Œæ”¯æŒå¤§æ–‡ä»¶
- âœ… **è¡¨æƒ…åŒ…ç³»ç»Ÿ** - GIF åŠ¨ç”»è¡¨æƒ…ï¼Œæ”¯æŒè‡ªå®šä¹‰
- âœ… **æˆªå›¾åŠŸèƒ½** - å…¨å±æˆªå›¾å·¥å…·
- âœ… **æ‘„åƒå¤´æ‹ç…§** - å®æ—¶é¢„è§ˆå’Œæ‹ç…§åŠŸèƒ½
- âœ… **ç”¨æˆ·åˆ†ç»„ç®¡ç†** - è‡ªåŠ¨åˆ†ç»„æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·
- âœ… **ç°ä»£åŒ– UI** - Fluent Design é£æ ¼ï¼Œæ”¯æŒæš—è‰²/äº®è‰²ä¸»é¢˜

### é¡¹ç›®å®šä½
- **ç›®æ ‡ç”¨æˆ·**: å±€åŸŸç½‘å†…çš„åŠå…¬å›¢é˜Ÿã€å­¦ä¹ å°ç»„
- **ä½¿ç”¨åœºæ™¯**: æ— éœ€å¤–ç½‘ã€æ— éœ€æ³¨å†Œçš„å³æ—¶é€šè®¯éœ€æ±‚
- **æŠ€æœ¯ç›®æ ‡**: å±•ç¤º PyQt5 GUI å¼€å‘ã€ç½‘ç»œç¼–ç¨‹ã€å¤šçº¿ç¨‹ç¼–ç¨‹èƒ½åŠ›

---

## æŠ€æœ¯æ ˆä¸é€‰å‹

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|----------|
| **Python** | 3.10+ | å¼€å‘è¯­è¨€ | å¿«é€Ÿå¼€å‘ï¼Œä¸°å¯Œçš„åº“ç”Ÿæ€ |
| **PyQt5** | 5.15.11 | GUI æ¡†æ¶ | è·¨å¹³å°ã€åŠŸèƒ½å¼ºå¤§ã€æ–‡æ¡£å®Œå–„ |
| **PyQt-Fluent-Widgets** | 1.8.7 | UI ç»„ä»¶åº“ | ç°ä»£åŒ– Fluent Design é£æ ¼ï¼Œç»Ÿä¸€è§†è§‰ä½“éªŒ |
| **PyQt5-Frameless-Window** | 0.7.3 | æ— è¾¹æ¡†çª—å£ | ç°ä»£åŒ–çª—å£æ ·å¼æ”¯æŒ |
| **OpenCV (cv2)** | - | æ‘„åƒå¤´å¤„ç† | è·¨å¹³å°æ‘„åƒå¤´è®¿é—®ï¼Œå›¾åƒå¤„ç†èƒ½åŠ› |
| **Pillow (PIL)** | 10.4.0 | å›¾åƒå¤„ç† | æˆªå›¾åŠŸèƒ½ï¼Œå›¾åƒæ ¼å¼è½¬æ¢ |

### æŠ€æœ¯é€‰å‹ç†ç”±

#### 1. **GUI æ¡†æ¶é€‰æ‹©: PyQt5**
- âœ… **æˆç†Ÿç¨³å®š**: å†å²æ‚ ä¹…ï¼Œç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£å®Œå–„
- âœ… **è·¨å¹³å°**: Windowsã€Linuxã€macOS ç»Ÿä¸€ä»£ç 
- âœ… **åŠŸèƒ½ä¸°å¯Œ**: å†…ç½®ç½‘ç»œã€æ•°æ®åº“ã€XML ç­‰æ¨¡å—
- âœ… **æ€§èƒ½ä¼˜ç§€**: C++ åº•å±‚ï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿåº”ç”¨
- âœ… **ä¿¡å·æ§½æœºåˆ¶**: è§£è€¦ç»„ä»¶é€šä¿¡ï¼Œä»£ç æ¸…æ™°

**ä¸ºä»€ä¹ˆä¸é€‰ Tkinterï¼Ÿ**
- Tkinter ç•Œé¢è¾ƒä¸ºç®€é™‹ï¼Œéš¾ä»¥å®ç°ç°ä»£åŒ– UI
- åŠŸèƒ½ç›¸å¯¹æœ‰é™ï¼Œç¼ºå°‘é«˜çº§æ§ä»¶

**ä¸ºä»€ä¹ˆä¸é€‰ PySide2/PySide6ï¼Ÿ**
- PyQt5 æ–‡æ¡£å’Œæ•™ç¨‹æ›´ä¸°å¯Œ
- PyQt-Fluent-Widgets ä¸»è¦æ”¯æŒ PyQt5

#### 2. **UI è®¾è®¡: Fluent Design**
- âœ… **ç°ä»£åŒ–**: ç¬¦åˆ Windows 11 è®¾è®¡è¯­è¨€
- âœ… **ç”¨æˆ·ä½“éªŒ**: æµç•…åŠ¨ç”»ã€æ¸…æ™°å±‚æ¬¡
- âœ… **ä¸»é¢˜æ”¯æŒ**: è‡ªåŠ¨é€‚é…ç³»ç»Ÿæš—è‰²/äº®è‰²ä¸»é¢˜
- âœ… **ç»„ä»¶ä¸°å¯Œ**: å†…ç½®å¤šç§ Fluent é£æ ¼æ§ä»¶

#### 3. **ç½‘ç»œé€šä¿¡: UDP + TCP æ··åˆæ¶æ„**
- **UDP (ç«¯å£ 2425)**: 
  - ç”¨æˆ·å‘ç°ï¼ˆå¹¿æ’­ä¸Šçº¿/ä¸‹çº¿æ¶ˆæ¯ï¼‰
  - æ–‡æœ¬æ¶ˆæ¯ä¼ è¾“ï¼ˆä½å»¶è¿Ÿï¼Œæ— éœ€è¿æ¥ï¼‰
  - æ–‡ä»¶ä¼ è¾“è¯·æ±‚/å“åº”ï¼ˆæ§åˆ¶ä¿¡ä»¤ï¼‰
- **TCP**: 
  - æ–‡ä»¶ä¼ è¾“ï¼ˆå¯é ä¼ è¾“ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§ï¼‰

**ä¸ºä»€ä¹ˆæ··åˆä½¿ç”¨ UDP å’Œ TCPï¼Ÿ**
- UDP é€‚åˆå±€åŸŸç½‘å†…çš„å¹¿æ’­å’Œè½»é‡æ¶ˆæ¯ï¼Œå»¶è¿Ÿä½
- TCP ä¿è¯æ–‡ä»¶ä¼ è¾“çš„å¯é æ€§ï¼Œè‡ªåŠ¨é‡ä¼ å’Œæµæ§
- å€Ÿé‰´æˆç†Ÿçš„ IPMSG åè®®è®¾è®¡

#### 4. **å¤šçº¿ç¨‹æ¶æ„: QThread**
- âœ… **ç½‘ç»œçº¿ç¨‹**: ç‹¬ç«‹çº¿ç¨‹å¤„ç† UDP æ¥æ”¶ï¼Œé¿å…é˜»å¡ UI
- âœ… **æ–‡ä»¶ä¼ è¾“çº¿ç¨‹**: æ–‡ä»¶å‘é€/æ¥æ”¶åœ¨ç‹¬ç«‹çº¿ç¨‹ï¼Œä¸å½±å“èŠå¤©
- âœ… **æ‘„åƒå¤´çº¿ç¨‹**: è§†é¢‘æ•è·åœ¨ç‹¬ç«‹çº¿ç¨‹ï¼Œä¿è¯ UI æµç•…

**ä¸ºä»€ä¹ˆä¸ç”¨ asyncioï¼Ÿ**
- PyQt5 çš„äº‹ä»¶å¾ªç¯ä¸ asyncio é›†æˆå¤æ‚
- QThread + ä¿¡å·æ§½æœºåˆ¶æ›´é€‚åˆ PyQt åº”ç”¨
- ä»£ç æ›´ç›´è§‚ï¼Œæ˜“äºç»´æŠ¤

---

## é¡¹ç›®æ¶æ„

### ç›®å½•ç»“æ„

```
Chatroom/
â”œâ”€â”€ main.py                    # åº”ç”¨ç¨‹åºå…¥å£
â”œâ”€â”€ core/                      # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ network.py             # ç½‘ç»œé€šä¿¡æ ¸å¿ƒï¼ˆUDP/TCPï¼‰
â”‚   â”œâ”€â”€ protocol.py            # IPMSG åè®®å®šä¹‰
â”‚   â””â”€â”€ file_transfer.py       # æ–‡ä»¶ä¼ è¾“ï¼ˆTCPï¼‰
â”œâ”€â”€ ui/                        # UI ç•Œé¢æ¨¡å—
â”‚   â”œâ”€â”€ main_window.py         # ä¸»çª—å£ï¼ˆç”¨æˆ·åˆ—è¡¨ã€å¯¼èˆªï¼‰
â”‚   â”œâ”€â”€ chat_window.py         # èŠå¤©çª—å£
â”‚   â”œâ”€â”€ group_chat_dialog.py   # ç¾¤èŠå¯¹è¯æ¡†
â”‚   â”œâ”€â”€ about_interface.py     # å…³äºé¡µé¢
â”‚   â””â”€â”€ components/            # å¯å¤ç”¨ç»„ä»¶
â”‚       â”œâ”€â”€ emoji_picker.py    # è¡¨æƒ…é€‰æ‹©å™¨
â”‚       â”œâ”€â”€ screenshot_tool.py # æˆªå›¾å·¥å…·
â”‚       â”œâ”€â”€ camera_widget.py   # æ‘„åƒå¤´ç»„ä»¶
â”‚       â””â”€â”€ animated_text_browser.py  # æ”¯æŒ GIF çš„æ–‡æœ¬æµè§ˆå™¨
â”œâ”€â”€ utils/                     # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ config.py              # é…ç½®ç®¡ç†ï¼ˆç”¨æˆ·åã€ä¸»é¢˜ç­‰ï¼‰
â”‚   â””â”€â”€ emoji_manager.py       # è¡¨æƒ…åŒ…ç®¡ç†
â””â”€â”€ resources/                 # èµ„æºæ–‡ä»¶
    â””â”€â”€ emojis/                # è¡¨æƒ… GIF æ–‡ä»¶
        â”œâ”€â”€ emoji_map.json     # è¡¨æƒ…æ˜ å°„è¡¨
        â””â”€â”€ gifs/              # GIF æ–‡ä»¶ç›®å½•
```

### æ¶æ„è®¾è®¡å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MainWindow                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ChatInterfaceâ”‚  â”‚ AboutInterfaceâ”‚  â”‚ Navigation   â”‚  â”‚
â”‚  â”‚ (ç”¨æˆ·åˆ—è¡¨)   â”‚  â”‚ (å…³äºé¡µé¢)    â”‚  â”‚ (å¯¼èˆªæ )     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚
           â”‚                    â”‚
           â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChatWindow      â”‚   â”‚  GroupChatDialog â”‚
â”‚  (ä¸€å¯¹ä¸€èŠå¤©)     â”‚   â”‚  (ç¾¤èŠå¯¹è¯æ¡†)     â”‚
â”‚                  â”‚   â”‚                  â”‚
â”‚  - TextEdit      â”‚   â”‚  - TextEdit      â”‚
â”‚  - EmojiPicker   â”‚   â”‚  - Recipients    â”‚
â”‚  - ScreenshotToolâ”‚   â”‚                  â”‚
â”‚  - CameraWidget  â”‚   â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NetworkCore (QThread)                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  UDP Socket  â”‚         â”‚  Protocol    â”‚            â”‚
â”‚  â”‚  (2425ç«¯å£)  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (IPMSG)     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                                                â”‚
â”‚         â”‚ Signals                                        â”‚
â”‚         â”‚ (user_online, message_received, etc.)         â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  FileSender / FileReceiver (QThread) â”‚              â”‚
â”‚  â”‚  (TCP Socket)                        â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµè®¾è®¡

#### 1. **ç”¨æˆ·ä¸Šçº¿æµç¨‹**
```
ç”¨æˆ·Aå¯åŠ¨åº”ç”¨
    â†“
NetworkCore.run() å¯åŠ¨ UDP ç›‘å¬
    â†“
broadcast_entry() å¹¿æ’­ IPMSG_BR_ENTRY
    â†“
å±€åŸŸç½‘å†…å…¶ä»–ç”¨æˆ·æ”¶åˆ°å¹¿æ’­
    â†“
å…¶ä»–ç”¨æˆ·å›å¤ IPMSG_ANSENTRY
    â†“
ç”¨æˆ·Aæ”¶åˆ°å›å¤ï¼Œemit user_online ä¿¡å·
    â†“
MainWindow.handle_user_online() æ›´æ–°ç”¨æˆ·åˆ—è¡¨
```

#### 2. **æ¶ˆæ¯å‘é€æµç¨‹**
```
ç”¨æˆ·åœ¨ ChatWindow è¾“å…¥æ¶ˆæ¯
    â†“
ChatWindow.send_message()
    â†“
NetworkCore.send_message() æ„é€  IPMSG_SENDMSG
    â†“
UDP Socket å‘é€åˆ°ç›®æ ‡ IP
    â†“
æ¥æ”¶æ–¹ NetworkCore.process_datagram()
    â†“
emit message_received ä¿¡å·
    â†“
MainWindow.handle_message_received()
    â†“
æ‰“å¼€/æ¿€æ´» ChatWindowï¼Œæ˜¾ç¤ºæ¶ˆæ¯
```

#### 3. **æ–‡ä»¶ä¼ è¾“æµç¨‹**
```
å‘é€æ–¹é€‰æ‹©æ–‡ä»¶
    â†“
ChatWindow.send_file_request.emit()
    â†“
NetworkCore.send_file_request() (UDP)
    â†“
æ¥æ”¶æ–¹æ”¶åˆ° IPMSG_SEND_FILE_REQUEST
    â†“
æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    â†“
ç”¨æˆ·åŒæ„æ¥æ”¶
    â†“
FileReceiver çº¿ç¨‹å¯åŠ¨ï¼Œç›‘å¬ TCP ç«¯å£
    â†“
emit ready_to_receive(port, path)
    â†“
NetworkCore.send_file_ready_signal() (UDP)
    â†“
å‘é€æ–¹æ”¶åˆ° IPMSG_RECV_FILE_READY
    â†“
FileSender çº¿ç¨‹å¯åŠ¨ï¼Œè¿æ¥ TCP ç«¯å£
    â†“
TCP ä¼ è¾“æ–‡ä»¶æ•°æ®
    â†“
ä¼ è¾“å®Œæˆï¼Œæ˜¾ç¤ºå›¾ç‰‡
```

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. ç½‘ç»œé€šä¿¡æ¨¡å— (`core/network.py`)

#### æ ¸å¿ƒç±»: `NetworkCore(QThread)`

**èŒè´£**: 
- UDP å¹¿æ’­ç”¨æˆ·ä¸Šçº¿/ä¸‹çº¿
- UDP æ”¶å‘æ–‡æœ¬æ¶ˆæ¯
- UDP æ”¶å‘æ–‡ä»¶ä¼ è¾“æ§åˆ¶æ¶ˆæ¯
- ç®¡ç†ç”¨æˆ·åœ¨çº¿çŠ¶æ€

**å…³é”®æ–¹æ³•**:

```python
def run(self):
    """ä¸»å¾ªç¯ï¼šç›‘å¬ UDP æ¶ˆæ¯"""
    self.udp_socket.bind(('', self.port))
    while self.running:
        data, addr = self.udp_socket.recvfrom(1024)
        self.process_datagram(data, addr)

def process_datagram(self, data, addr):
    """è§£æå¹¶å¤„ç† UDP æ•°æ®åŒ…"""
    msg = protocol.parse_message(data)
    mode = msg['command'] & protocol.IPMSG_MODE_MASK
    
    if mode == protocol.IPMSG_BR_ENTRY:
        # ç”¨æˆ·ä¸Šçº¿
        self.user_online.emit(msg, addr[0])
        self.answer_entry(addr[0], self.port)
    elif mode == protocol.IPMSG_SENDMSG:
        # æ”¶åˆ°æ¶ˆæ¯
        self.message_received.emit(msg, addr[0])
```

**ä¿¡å·å®šä¹‰**:
- `user_online(dict, str)`: ç”¨æˆ·ä¸Šçº¿
- `user_offline(dict, str)`: ç”¨æˆ·ä¸‹çº¿
- `message_received(dict, str)`: æ”¶åˆ°æ¶ˆæ¯
- `file_request_received(dict, str)`: æ”¶åˆ°æ–‡ä»¶è¯·æ±‚
- `file_receiver_ready(dict, str)`: æ¥æ”¶æ–¹å‡†å¤‡å°±ç»ª

**æŠ€æœ¯è¦ç‚¹**:
- ä½¿ç”¨ `QThread` é¿å…é˜»å¡ UI çº¿ç¨‹
- UDP Socket è®¾ç½® `SO_BROADCAST` é€‰é¡¹æ”¯æŒå¹¿æ’­
- è¶…æ—¶æœºåˆ¶ (`settimeout(1.0)`) å…è®¸å®šæœŸæ£€æŸ¥ `running` æ ‡å¿—

### 2. åè®®æ¨¡å— (`core/protocol.py`)

#### IPMSG åè®®å®ç°

**åè®®æ ¼å¼**:
```
ç‰ˆæœ¬å·:åŒ…ç¼–å·:å‘é€è€…:å‘é€ä¸»æœº:å‘½ä»¤:é™„åŠ ä¿¡æ¯
ä¾‹å¦‚: "1:12345:user1:host1:32:Hello World"
```

**æ ¸å¿ƒå‘½ä»¤å¸¸é‡**:
```python
IPMSG_BR_ENTRY = 0x00000001        # å¹¿æ’­ä¸Šçº¿
IPMSG_BR_EXIT = 0x00000002         # å¹¿æ’­ä¸‹çº¿
IPMSG_ANSENTRY = 0x00000003        # å›åº”ä¸Šçº¿
IPMSG_SENDMSG = 0x00000020         # å‘é€æ¶ˆæ¯
IPMSG_SEND_FILE_REQUEST = 0x00000060  # æ–‡ä»¶ä¼ è¾“è¯·æ±‚
IPMSG_RECV_FILE_READY = 0x00000061   # æ¥æ”¶æ–¹å‡†å¤‡å°±ç»ª
```

**æ¶ˆæ¯æ ¼å¼åŒ–/è§£æ**:
```python
def format_message(packet_no, sender, host, command, extra_msg):
    """æ„é€  UDP æ¶ˆæ¯åŒ…"""
    return b":".join([
        IPMSG_VERSION,
        str(packet_no).encode('utf-8'),
        sender.encode('utf-8'),
        host.encode('utf-8'),
        str(command).encode('utf-8'),
        extra_msg.encode('utf-8')
    ])

def parse_message(data):
    """è§£æ UDP æ¶ˆæ¯åŒ…"""
    parts = data.split(b':', 5)
    return {
        'version': parts[0].decode('utf-8'),
        'packet_no': int(parts[1]),
        'sender': parts[2].decode('utf-8'),
        'host': parts[3].decode('utf-8'),
        'command': int(parts[4]),
        'extra_msg': parts[5].decode('utf-8') if len(parts) > 5 else ''
    }
```

**ä¸ºä»€ä¹ˆé€‰æ‹© IPMSG åè®®ï¼Ÿ**
- âœ… æˆç†Ÿç¨³å®šï¼šFeiQ ç­‰è½¯ä»¶å¹¿æ³›ä½¿ç”¨
- âœ… ç®€å•é«˜æ•ˆï¼šæ–‡æœ¬åè®®ï¼Œæ˜“äºè°ƒè¯•
- âœ… æ‰©å±•æ€§å¥½ï¼šå‘½ä»¤ä½æ©ç è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
- âœ… æ–‡æ¡£å®Œå–„ï¼šæœ‰å‚è€ƒå®ç°ï¼ˆC++ ç‰ˆæœ¬ï¼‰

### 3. æ–‡ä»¶ä¼ è¾“æ¨¡å— (`core/file_transfer.py`)

#### FileReceiver (TCP Server)

**å·¥ä½œæµç¨‹**:
1. åˆ›å»º TCP Socketï¼Œç»‘å®šåˆ°éšæœºç«¯å£ï¼ˆ`bind(('', 0))`ï¼‰
2. ç›‘å¬è¿æ¥ (`listen(1)`)
3. å‘é€ `ready_to_receive` ä¿¡å·ï¼Œå‘ŠçŸ¥ç«¯å£å·
4. æ¥å—è¿æ¥ï¼Œæ¥æ”¶æ–‡ä»¶æ•°æ®
5. å†™å…¥æ–‡ä»¶ï¼Œå‘é€ `transfer_finished` ä¿¡å·

**å…³é”®ä»£ç **:
```python
def run(self):
    self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    self.server_socket.bind(('', 0))  # éšæœºç«¯å£
    port = self.server_socket.getsockname()[1]
    self.server_socket.listen(1)
    
    self.ready_to_receive.emit(port, save_path)
    
    conn, addr = self.server_socket.accept()
    with open(save_path, 'wb') as f:
        while received_size < self.filesize:
            data = conn.recv(4096)
            f.write(data)
```

#### FileSender (TCP Client)

**å·¥ä½œæµç¨‹**:
1. åˆ›å»º TCP Socket
2. è¿æ¥åˆ°æ¥æ”¶æ–¹æä¾›çš„ç«¯å£
3. è¯»å–æ–‡ä»¶å¹¶å‘é€æ•°æ®
4. å‘é€å®Œæˆï¼Œå…³é—­è¿æ¥

**ä¸ºä»€ä¹ˆä½¿ç”¨ TCPï¼Ÿ**
- âœ… å¯é æ€§ï¼šè‡ªåŠ¨é‡ä¼ ä¸¢å¤±çš„æ•°æ®åŒ…
- âœ… æµæ§ï¼šé¿å…å‘é€è¿‡å¿«å¯¼è‡´æ¥æ”¶æ–¹ç¼“å†²åŒºæº¢å‡º
- âœ… æœ‰åºæ€§ï¼šä¿è¯æ–‡ä»¶æ•°æ®çš„é¡ºåº

### 4. ä¸»çª—å£æ¨¡å— (`ui/main_window.py`)

#### MainWindow (FluentWindow)

**æ ¸å¿ƒåŠŸèƒ½**:
- ç”¨æˆ·åˆ—è¡¨ç®¡ç†ï¼ˆTreeWidgetï¼Œæ”¯æŒåˆ†ç»„ï¼‰
- èŠå¤©çª—å£ç®¡ç†ï¼ˆå­—å…¸ `chat_windows`ï¼‰
- å¯¼èˆªæ ï¼ˆFluentWindow å†…ç½®ï¼‰
- ä¿¡å·è·¯ç”±ï¼ˆè¿æ¥ NetworkCore å’Œ UIï¼‰

**ç”¨æˆ·åˆ—è¡¨å®ç°**:
```python
def update_user_list(self):
    """æ›´æ–°ç”¨æˆ·åˆ—è¡¨ï¼ŒæŒ‰åˆ†ç»„æ˜¾ç¤º"""
    groups = {}
    sorted_users = sorted(users_list, key=lambda u: (u.get('group_name', ''), u.get('display_name', '')))
    
    for user_info in sorted_users:
        group_name = user_info.get('group_name', 'æˆ‘çš„å¥½å‹')
        if group_name not in groups:
            group_item = QTreeWidgetItem(self.chat_interface.user_tree_widget)
            group_item.setText(0, f"{group_name} [0]")
            groups[group_name] = group_item
        
        user_item = QTreeWidgetItem(group_item)
        user_item.setText(0, f"{display_name} ({ip})")
```

**æŠ€æœ¯è¦ç‚¹**:
- ä½¿ç”¨ `QTreeWidget` å®ç°åˆ†ç»„æ ‘å½¢ç»“æ„
- ä½¿ç”¨ `Qt.UserRole` å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼ˆIPã€ç±»å‹ç­‰ï¼‰
- æœç´¢è¿‡æ»¤åŠŸèƒ½ï¼šéå†æ ‘èŠ‚ç‚¹ï¼ŒåŠ¨æ€æ˜¾ç¤º/éšè—

### 5. èŠå¤©çª—å£æ¨¡å— (`ui/chat_window.py`)

#### ChatWindow (FramelessWindow)

**æ ¸å¿ƒåŠŸèƒ½**:
- æ¶ˆæ¯æ˜¾ç¤ºï¼ˆæ”¯æŒ HTMLã€GIF è¡¨æƒ…ï¼‰
- æ¶ˆæ¯è¾“å…¥ï¼ˆTextEditï¼‰
- è¡¨æƒ…é€‰æ‹©å™¨
- æˆªå›¾å·¥å…·
- æ‘„åƒå¤´æ‹ç…§
- æ–‡ä»¶ä¼ è¾“å¯¹è¯æ¡†

**æ¶ˆæ¯æ˜¾ç¤ºå®ç°**:
```python
def append_message(self, text, sender_name, is_own=False):
    """æ·»åŠ æ¶ˆæ¯åˆ°æ˜¾ç¤ºåŒºåŸŸ"""
    sender_html = f'<p style="color: green;"><b>{sender_name} (æˆ‘):</b></p>' if is_own else f'<p style="color: blue;"><b>{sender_name}:</b></p>'
    content_html = self.format_text_for_display(text)  # å¤„ç†è¡¨æƒ…ä»£ç  [1] -> <img src="emoji:[1]" />
    full_html = f'{sender_html}<div style="margin-left: 10px;">{content_html}</div>'
    self.message_display.append(full_html)
```

**è¡¨æƒ…å¤„ç†**:
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ `re.sub(r'\[\d+\]', replace_emoji, text)` æ›¿æ¢è¡¨æƒ…ä»£ç 
- è‡ªå®šä¹‰èµ„æºåè®® `emoji:[1]` åœ¨ `AnimatedTextBrowser` ä¸­å¤„ç†

### 6. è¡¨æƒ…ç³»ç»Ÿ (`ui/components/animated_text_browser.py`)

#### AnimatedTextBrowser (QTextBrowser)

**æ ¸å¿ƒåŠŸèƒ½**:
- è‡ªå®šä¹‰èµ„æºåŠ è½½ï¼ˆ`loadResource` æ–¹æ³•ï¼‰
- GIF åŠ¨ç”»æ’­æ”¾ï¼ˆ`QMovie`ï¼‰
- LRU ç¼“å­˜æœºåˆ¶ï¼ˆé™åˆ¶å†…å­˜å ç”¨ï¼‰

**å…³é”®å®ç°**:
```python
def loadResource(self, type, name: QUrl):
    """é‡å†™èµ„æºåŠ è½½ï¼Œå¤„ç† emoji: åè®®"""
    if name.scheme() == 'emoji':
        if url_str in self.movie_cache:
            self.movie_cache.move_to_end(url_str)  # LRU
            return self.movie_cache[url_str]
        
        movie = self.create_movie_for_emoji(name)
        if len(self.movie_cache) >= self.MAX_CACHE_SIZE:
            # ç§»é™¤æœ€æ—§çš„ç¼“å­˜
            oldest_movie = self.movie_cache.popitem(last=False)[1]
            oldest_movie.stop()
        
        self.movie_cache[url_str] = movie
        return movie

def on_frame_changed(self, url: QUrl):
    """GIF å¸§æ›´æ–°æ—¶ï¼Œæ›´æ–°æ–‡æ¡£èµ„æºå¹¶é‡ç»˜"""
    movie = self.movie_cache.get(url.toString())
    if movie:
        self.document().addResource(QTextDocument.ImageResource, url, movie.currentPixmap())
        self.viewport().update()
```

**æ€§èƒ½ä¼˜åŒ–**:
- LRU ç¼“å­˜ï¼šæœ€å¤šç¼“å­˜ 20 ä¸ªè¡¨æƒ…ï¼Œé¿å…å†…å­˜æ— é™å¢é•¿
- å¸§æ›´æ–°ä¼˜åŒ–ï¼šåªåœ¨å¸§å˜åŒ–æ—¶æ›´æ–°è§†å›¾ï¼Œå‡å°‘é‡ç»˜æ¬¡æ•°
- æš‚åœæœºåˆ¶ï¼šæ¨¡æ€å¯¹è¯æ¡†æ˜¾ç¤ºæ—¶æš‚åœåŠ¨ç”»ï¼Œå‡å°‘ CPU å ç”¨

### 7. æˆªå›¾å·¥å…· (`ui/components/screenshot_tool.py`)

#### ScreenshotTool (QWidget)

**å®ç°åŸç†**:
1. å…¨å±çª—å£ï¼Œæ•è·å±å¹•æˆªå›¾
2. é¼ æ ‡æ‹–åŠ¨é€‰æ‹©åŒºåŸŸ
3. `paintEvent` ç»˜åˆ¶é®ç½©å’Œé€‰ä¸­åŒºåŸŸ
4. ä¿å­˜é€‰ä¸­åŒºåŸŸåˆ°æ–‡ä»¶

**å…³é”®ä»£ç **:
```python
def paintEvent(self, event):
    painter = QPainter(self)
    painter.drawPixmap(self.rect(), self.background)  # èƒŒæ™¯æˆªå›¾
    painter.setBrush(QBrush(QColor(0, 0, 0, 128)))   # åŠé€æ˜é®ç½©
    painter.drawRect(self.rect())
    
    if self.begin and self.end:
        selection_rect = QRect(self.begin, self.end).normalized()
        selected_pixmap = self.background.copy(selection_rect)
        painter.drawPixmap(selection_rect.topLeft(), selected_pixmap)  # æ˜¾ç¤ºé€‰ä¸­åŒºåŸŸ
        painter.setPen(QPen(Qt.red, 2))
        painter.drawRect(selection_rect)  # ç»˜åˆ¶è¾¹æ¡†
```

**æŠ€æœ¯è¦ç‚¹**:
- ä½¿ç”¨ `QGuiApplication.primaryScreen().grabWindow()` æ•è·å±å¹•
- çª—å£æ ‡å¿—ï¼š`Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint`
- é¼ æ ‡äº‹ä»¶ï¼š`mousePressEvent` / `mouseMoveEvent` / `mouseReleaseEvent`

### 8. æ‘„åƒå¤´ç»„ä»¶ (`ui/components/camera_widget.py`)

#### CameraCaptureThread (QThread)

**å®ç°åŸç†**:
1. ç‹¬ç«‹çº¿ç¨‹æ•è·æ‘„åƒå¤´å¸§ï¼ˆé¿å…é˜»å¡ UIï¼‰
2. é™ä½å¸§ç‡ï¼ˆ15 FPSï¼‰å’Œåˆ†è¾¨ç‡ï¼ˆ640x480ï¼‰ä»¥èŠ‚çœèµ„æº
3. ä½¿ç”¨ OpenCV (`cv2.VideoCapture`) è®¿é—®æ‘„åƒå¤´
4. é€šè¿‡ä¿¡å·ä¼ é€’å¸§æ•°æ®åˆ° UI çº¿ç¨‹

**å…³é”®ä»£ç **:
```python
def run(self):
    self.cap = cv2.VideoCapture(self.camera_index)
    self.cap.set(cv2.CAP_PROP_FRAME_WIDTH, self.resolution[0])
    self.cap.set(cv2.CAP_PROP_FRAME_HEIGHT, self.resolution[1])
    self.cap.set(cv2.CAP_PROP_FPS, self.fps)
    
    frame_interval = int(1000 / self.fps)
    while self.running:
        ret, frame = self.cap.read()
        if ret:
            self.frame_ready.emit(frame)
        self.msleep(frame_interval)
```

**æ€§èƒ½ä¼˜åŒ–**:
- é™ä½å¸§ç‡ï¼š15 FPS è¶³å¤Ÿé¢„è§ˆï¼Œå‡å°‘ CPU å ç”¨
- é™ä½åˆ†è¾¨ç‡ï¼š640x480 å¹³è¡¡è´¨é‡å’Œæ€§èƒ½
- JPEG å‹ç¼©ï¼šä¿å­˜æ—¶ä½¿ç”¨ 85% è´¨é‡ï¼Œå‡å°æ–‡ä»¶å¤§å°

---

## åŠŸèƒ½å®ç°ç»†èŠ‚

### 1. ç”¨æˆ·å‘ç°æœºåˆ¶

**å®ç°æ–¹å¼**: UDP å¹¿æ’­

**æµç¨‹**:
1. åº”ç”¨å¯åŠ¨æ—¶ï¼Œ`NetworkCore` ç»‘å®š UDP ç«¯å£ 2425
2. å‘é€ `IPMSG_BR_ENTRY` å¹¿æ’­æ¶ˆæ¯ï¼ˆ`<broadcast>` åœ°å€ï¼‰
3. å±€åŸŸç½‘å†…å…¶ä»–ç”¨æˆ·æ”¶åˆ°å¹¿æ’­ï¼Œå›å¤ `IPMSG_ANSENTRY`
4. åŒæ–¹æ›´æ–°ç”¨æˆ·åˆ—è¡¨

**ä»£ç ç¤ºä¾‹**:
```python
def broadcast_entry(self):
    payload = f"{self.username}\0{self.groupname}"
    self._send_udp_message(protocol.IPMSG_BR_ENTRY, payload, '<broadcast>')

def answer_entry(self, dest_ip, dest_port):
    payload = f"{self.username}\0{self.groupname}"
    self._send_udp_message(protocol.IPMSG_ANSENTRY, payload, dest_ip, dest_port)
```

**ä¸ºä»€ä¹ˆä½¿ç”¨å¹¿æ’­è€Œä¸æ˜¯å¤šæ’­ï¼Ÿ**
- å¹¿æ’­æ›´ç®€å•ï¼Œä¸éœ€è¦ç»„ç®¡ç†
- å±€åŸŸç½‘ç¯å¢ƒï¼Œå¹¿æ’­æ€§èƒ½è¶³å¤Ÿ
- å…¼å®¹æ€§æ›´å¥½ï¼ˆæŸäº›ç½‘ç»œé…ç½®å¯èƒ½ä¸æ”¯æŒå¤šæ’­ï¼‰

### 2. æ¶ˆæ¯æ”¶å‘æœºåˆ¶

**æ–‡æœ¬æ¶ˆæ¯æ ¼å¼**:
```
ç‰ˆæœ¬å·:åŒ…ç¼–å·:å‘é€è€…:ä¸»æœº:å‘½ä»¤:æ¶ˆæ¯å†…å®¹
ä¾‹å¦‚: "1:12345:Alice:PC-01:32:Hello World"
```

**å›æ‰§æœºåˆ¶**:
- å‘é€æ–¹è®¾ç½® `IPMSG_SENDCHECKOPT` æ ‡å¿—
- æ¥æ”¶æ–¹æ”¶åˆ°æ¶ˆæ¯åï¼Œå‘é€ `IPMSG_RECVMSG` å›æ‰§
- å‘é€æ–¹æ”¶åˆ°å›æ‰§ï¼Œç¡®è®¤æ¶ˆæ¯å·²é€è¾¾

**ä»£ç ç¤ºä¾‹**:
```python
def send_message(self, message_text, dest_ip):
    command = protocol.IPMSG_SENDMSG | protocol.IPMSG_SENDCHECKOPT
    self._send_udp_message(command, message_text, dest_ip)

def send_receipt(self, dest_ip, dest_port, packet_no):
    self._send_udp_message(protocol.IPMSG_RECVMSG, str(packet_no), dest_ip, dest_port)
```

### 3. æ–‡ä»¶ä¼ è¾“æœºåˆ¶

**ä¸¤æ­¥æ¡æ‰‹æµç¨‹**:

1. **è¯·æ±‚é˜¶æ®µ (UDP)**:
   - å‘é€æ–¹ï¼š`IPMSG_SEND_FILE_REQUEST` + `filename:filesize`
   - æ¥æ”¶æ–¹ï¼šæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†

2. **ä¼ è¾“é˜¶æ®µ (TCP)**:
   - æ¥æ”¶æ–¹ï¼šå¯åŠ¨ TCP Serverï¼Œç›‘å¬éšæœºç«¯å£
   - æ¥æ”¶æ–¹ï¼šå‘é€ `IPMSG_RECV_FILE_READY` + `tcp_port:packet_no`
   - å‘é€æ–¹ï¼šå¯åŠ¨ TCP Clientï¼Œè¿æ¥åˆ°æŒ‡å®šç«¯å£
   - TCP ä¼ è¾“æ–‡ä»¶æ•°æ®

**ä¸ºä»€ä¹ˆåˆ†ä¸¤æ­¥ï¼Ÿ**
- UDP è¯·æ±‚ï¼šå¿«é€Ÿé€šçŸ¥ï¼Œä¸éœ€è¦å»ºç«‹è¿æ¥
- TCP ä¼ è¾“ï¼šä¿è¯æ–‡ä»¶æ•°æ®å¯é ä¼ è¾“
- ç”¨æˆ·ç¡®è®¤ï¼šé˜²æ­¢æ¶æ„æ–‡ä»¶ä¼ è¾“

### 4. å›¾ç‰‡ä¼ è¾“æœºåˆ¶

å›¾ç‰‡ä¼ è¾“æ˜¯æ–‡ä»¶ä¼ è¾“çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œæ”¯æŒä¸¤ç§å›¾ç‰‡æ¥æºï¼š**æˆªå›¾**å’Œ**æ‘„åƒå¤´æ‹ç…§**ã€‚å›¾ç‰‡ä¼ è¾“åŒæ ·é‡‡ç”¨ UDP + TCP æ··åˆæ¶æ„ï¼Œä½†å¢åŠ äº†æœ¬åœ°é¢„è§ˆå’Œè‡ªåŠ¨æ˜¾ç¤ºåŠŸèƒ½ã€‚

#### 4.1 å›¾ç‰‡è·å–æµç¨‹

**æˆªå›¾æµç¨‹** (`ui/components/screenshot_tool.py`):
1. ç”¨æˆ·ç‚¹å‡»æˆªå›¾æŒ‰é’®
2. éšè—èŠå¤©çª—å£å’Œä¸»çª—å£
3. åˆ›å»ºå…¨å± `ScreenshotTool` çª—å£
4. æ•è·å±å¹•æˆªå›¾ (`QGuiApplication.primaryScreen().grabWindow()`)
5. ç”¨æˆ·æ‹–åŠ¨é¼ æ ‡é€‰æ‹©åŒºåŸŸ
6. ä¿å­˜é€‰ä¸­åŒºåŸŸåˆ° `cache/screenshot_{timestamp}.png`
7. å‘é€ `screenshot_taken` ä¿¡å·ï¼Œå‚æ•°ä¸ºå›¾ç‰‡è·¯å¾„

**æ‘„åƒå¤´æ‹ç…§æµç¨‹** (`ui/components/camera_widget.py`):
1. ç”¨æˆ·ç‚¹å‡»æ‘„åƒå¤´æŒ‰é’®
2. æ‰“å¼€ `CameraDialog` å¯¹è¯æ¡†
3. `CameraCaptureThread` å¯åŠ¨ï¼Œæ•è·æ‘„åƒå¤´å¸§ï¼ˆ15 FPSï¼Œ640x480ï¼‰
4. å®æ—¶é¢„è§ˆæ‘„åƒå¤´ç”»é¢
5. ç”¨æˆ·ç‚¹å‡»æ‹ç…§æŒ‰é’®
6. ä¿å­˜å½“å‰å¸§åˆ° `cache/camera_{timestamp}.jpg`ï¼ˆJPEG 85% è´¨é‡ï¼‰
7. å‘é€ `photo_captured` ä¿¡å·ï¼Œå‚æ•°ä¸ºå›¾ç‰‡è·¯å¾„

#### 4.2 å›¾ç‰‡ä¼ è¾“å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é€æ–¹ï¼ˆæˆªå›¾/æ‹ç…§ï¼‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 1. å›¾ç‰‡ä¿å­˜åˆ° cache ç›®å½•
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ChatWindow.handle_screenshot_ â”‚
        â”‚     taken() /                 â”‚
        â”‚ handle_photo_captured()       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 2. æœ¬åœ°é¢„è§ˆï¼ˆappend_imageï¼‰
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  æ˜¾ç¤ºå›¾ç‰‡åœ¨èŠå¤©çª—å£            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 3. å‘é€æ–‡ä»¶ä¼ è¾“è¯·æ±‚ï¼ˆUDPï¼‰
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ send_file_request.emit(       â”‚
        â”‚     target_ip, image_path)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 4. NetworkCore.send_file_request()
                        â”‚    UDP: IPMSG_SEND_FILE_REQUEST
                        â”‚    payload: "filename:filesize"
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥æ”¶æ–¹                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 5. NetworkCore.process_datagram()
                        â”‚    æ”¶åˆ° IPMSG_SEND_FILE_REQUEST
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ChatWindow.handle_file_       â”‚
        â”‚     request()                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 6. æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                        â”‚    "ç”¨æˆ· XXX æƒ³ä¼ é€æ–‡ä»¶: filename, size"
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ç”¨æˆ·ç‚¹å‡»"åŒæ„æ¥æ”¶"           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 7. å¯åŠ¨ FileReceiver çº¿ç¨‹
                        â”‚    TCP Server ç›‘å¬éšæœºç«¯å£
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ FileReceiver.run()            â”‚
        â”‚ - bind(('', 0)) éšæœºç«¯å£      â”‚
        â”‚ - listen(1)                    â”‚
        â”‚ - emit ready_to_receive(port) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 8. å‘é€å‡†å¤‡å°±ç»ªä¿¡å·ï¼ˆUDPï¼‰
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ NetworkCore.send_file_ready_  â”‚
        â”‚     signal()                  â”‚
        â”‚ UDP: IPMSG_RECV_FILE_READY    â”‚
        â”‚ payload: "tcp_port:packet_no" â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 9. å‘é€æ–¹æ”¶åˆ°å‡†å¤‡ä¿¡å·
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é€æ–¹                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 10. ChatWindow.handle_file_ready()
                        â”‚     ä» pending_files è·å–æ–‡ä»¶è·¯å¾„
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  å¯åŠ¨ FileSender çº¿ç¨‹         â”‚
        â”‚  TCP Client è¿æ¥åˆ°æ¥æ”¶æ–¹ç«¯å£  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 11. TCP ä¼ è¾“å›¾ç‰‡æ•°æ®
                        â”‚     4096 å­—èŠ‚/å—
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ FileSender.run()              â”‚
        â”‚ - connect((host, port))       â”‚
        â”‚ - read file in 4096 chunks    â”‚
        â”‚ - sendall(data)               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 12. ä¼ è¾“å®Œæˆ
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥æ”¶æ–¹                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 13. FileReceiver æ¥æ”¶å®Œæˆ
                        â”‚     emit transfer_finished(path)
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ChatWindow.append_image()     â”‚
        â”‚   æ˜¾ç¤ºå›¾ç‰‡åœ¨èŠå¤©çª—å£           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3 å…³é”®ä»£ç å®ç°

**æˆªå›¾å®Œæˆåå‘é€**:
```python
@pyqtSlot(str)
def handle_screenshot_taken(self, image_path):
    """æˆªå›¾å®Œæˆåçš„å¤„ç†"""
    self.show()
    self.main_window.show()
    self.activateWindow()
    # 1. æœ¬åœ°é¢„è§ˆ
    self.append_image(image_path, self.own_username, is_own=True)
    # 2. å‘é€æ–‡ä»¶ä¼ è¾“è¯·æ±‚
    self.send_file_request.emit(self.target_ip, image_path)
```

**å›¾ç‰‡æ˜¾ç¤ºå®ç°**:
```python
def append_image(self, image_path, sender_name, is_own=False):
    """åœ¨èŠå¤©çª—å£æ˜¾ç¤ºå›¾ç‰‡"""
    header = f'<p style="color: green;"><b>{sender_name} (æˆ‘) å‘é€äº†æˆªå›¾:</b></p>' if is_own else f'<p style="color: blue;"><b>{sender_name} å‘é€äº†æˆªå›¾:</b></p>'
    self.message_display.append(header)
    
    # å°†å›¾ç‰‡æ’å…¥åˆ°æ–‡æ¡£ä¸­
    image_url = QUrl.fromLocalFile(os.path.abspath(image_path))
    cursor = self.message_display.textCursor()
    cursor.movePosition(QTextCursor.End)
    cursor.insertBlock()
    
    image_format = QTextImageFormat()
    image_format.setName(image_url.toString())
    cursor.insertImage(image_format)
    cursor.insertBlock()
```

**æ–‡ä»¶ä¼ è¾“è¯·æ±‚å¤„ç†**:
```python
@pyqtSlot(dict, str)
def handle_file_request(self, msg, sender_ip):
    """å¤„ç†æ–‡ä»¶ä¼ è¾“è¯·æ±‚"""
    parts = msg['extra_msg'].split(':')
    filename, filesize = parts[0], parts[1]
    
    # æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    w = MessageBox(title, content, self)
    
    def on_accept():
        # å¯åŠ¨æ¥æ”¶çº¿ç¨‹
        self.receiver_thread = FileReceiver("cache", filename, filesize)
        self.receiver_thread.ready_to_receive.connect(
            lambda port, save_path: self.send_file_ready.emit(port, msg['packet_no'], sender_ip)
        )
        self.receiver_thread.transfer_finished.connect(
            lambda path: self.append_image(path, self.target_user_info['sender'], is_own=False)
        )
        self.receiver_thread.start()
```

#### 4.4 å›¾ç‰‡ä¼ è¾“ç‰¹ç‚¹

**å­˜å‚¨ä½ç½®**:
- å‘é€æ–¹ï¼š`cache/screenshot_{timestamp}.png` æˆ– `cache/camera_{timestamp}.jpg`
- æ¥æ”¶æ–¹ï¼š`cache/{filename}`ï¼ˆä¿æŒåŸæ–‡ä»¶åï¼‰

**æ–‡ä»¶æ ¼å¼**:
- æˆªå›¾ï¼šPNG æ ¼å¼ï¼ˆæ— æŸï¼‰
- æ‘„åƒå¤´ï¼šJPEG æ ¼å¼ï¼ˆ85% è´¨é‡ï¼Œå¹³è¡¡å¤§å°å’Œè´¨é‡ï¼‰

**ç”¨æˆ·ä½“éªŒä¼˜åŒ–**:
- âœ… **å³æ—¶é¢„è§ˆ**ï¼šå‘é€æ–¹æˆªå›¾/æ‹ç…§åç«‹å³åœ¨èŠå¤©çª—å£æ˜¾ç¤º
- âœ… **è‡ªåŠ¨æ˜¾ç¤º**ï¼šæ¥æ”¶æ–¹æ¥æ”¶å®Œæˆåè‡ªåŠ¨æ˜¾ç¤ºå›¾ç‰‡
- âœ… **ç¡®è®¤æœºåˆ¶**ï¼šæ¥æ”¶æ–¹å¯ä»¥æ‹’ç»æ¥æ”¶ï¼Œé˜²æ­¢æ¶æ„æ–‡ä»¶ä¼ è¾“
- âœ… **æ–‡ä»¶ç®¡ç†**ï¼šæ‰€æœ‰å›¾ç‰‡ç»Ÿä¸€ä¿å­˜åœ¨ `cache` ç›®å½•

**æŠ€æœ¯ç»†èŠ‚**:
- ä½¿ç”¨ `QTextImageFormat` å’Œ `QTextCursor.insertImage()` åœ¨ HTML æ–‡æ¡£ä¸­æ’å…¥å›¾ç‰‡
- å›¾ç‰‡è·¯å¾„ä½¿ç”¨ `QUrl.fromLocalFile()` è½¬æ¢ä¸ºæœ¬åœ°æ–‡ä»¶ URL
- TCP ä¼ è¾“ä½¿ç”¨ 4096 å­—èŠ‚å—å¤§å°ï¼Œå¹³è¡¡å†…å­˜å’Œæ€§èƒ½
- æ¥æ”¶æ–¹ä½¿ç”¨éšæœºç«¯å£ï¼ˆ`bind(('', 0))`ï¼‰ï¼Œé¿å…ç«¯å£å†²çª

### 5. ç¾¤èŠå®ç°

**å®ç°æ–¹å¼**: å¾ªç¯å‘é€ä¸€å¯¹ä¸€æ¶ˆæ¯

**ä»£ç ç¤ºä¾‹**:
```python
def send_group_message(self):
    message_text = self.message_input.toPlainText().strip()
    full_message = f"(æ¥è‡ªç¾¤ç»„ '{self.group_name}' çš„æ¶ˆæ¯)\n{message_text}"
    
    for recipient in self.recipients:
        target_ip = recipient['ip']
        self.network_core.send_message(full_message, target_ip)
        
        # åœ¨æœ¬åœ°èŠå¤©çª—å£ä¹Ÿæ˜¾ç¤º
        if target_ip in self.main_window.chat_windows:
            self.main_window.chat_windows[target_ip].append_message(full_message, self.own_username, is_own=True)
```

**ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šæ’­ï¼Ÿ**
- å¤šæ’­éœ€è¦ç»„ç®¡ç†ï¼Œå®ç°å¤æ‚
- éœ€è¦å¤„ç†æˆå‘˜åŠ å…¥/ç¦»å¼€
- å½“å‰å®ç°ç®€å•å¯é ï¼Œæ»¡è¶³éœ€æ±‚

### 5. è¡¨æƒ…ç³»ç»Ÿå®ç°

**è¡¨æƒ…ä»£ç æ ¼å¼**: `[1]`, `[2]`, ... `[96]`

**æ˜ å°„æ–‡ä»¶**: `resources/emojis/emoji_map.json`
```json
{
  "[1]": "face1.gif",
  "[2]": "face2.gif",
  ...
}
```

**æ˜¾ç¤ºæµç¨‹**:
1. ç”¨æˆ·è¾“å…¥ `[1]`
2. `format_text_for_display()` è½¬æ¢ä¸º `<img src="emoji:[1]" />`
3. `AnimatedTextBrowser.loadResource()` åŠ è½½ GIF
4. `QMovie` æ’­æ”¾åŠ¨ç”»
5. `on_frame_changed()` æ›´æ–°æ˜¾ç¤º

**ç¼“å­˜ç­–ç•¥**: LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰
- æœ€å¤šç¼“å­˜ 20 ä¸ªè¡¨æƒ…
- è¶…å‡ºé™åˆ¶æ—¶ï¼Œç§»é™¤æœ€æ—§çš„ç¼“å­˜
- å‡å°‘å†…å­˜å ç”¨ï¼Œæé«˜æ€§èƒ½

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. PyQt5 ä¿¡å·æ§½æœºåˆ¶

**ä¿¡å·æ§½çš„ä¼˜åŠ¿**:
- âœ… **è§£è€¦**: å‘é€æ–¹ä¸éœ€è¦çŸ¥é“æ¥æ”¶æ–¹
- âœ… **ç±»å‹å®‰å…¨**: ä¿¡å·å‚æ•°ç±»å‹æ£€æŸ¥
- âœ… **çº¿ç¨‹å®‰å…¨**: è·¨çº¿ç¨‹é€šä¿¡è‡ªåŠ¨å¤„ç†

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# å®šä¹‰ä¿¡å·
class NetworkCore(QThread):
    message_received = pyqtSignal(dict, str)
    
# å‘å°„ä¿¡å·
self.message_received.emit(msg, addr[0])

# è¿æ¥ä¿¡å·
self.network_thread.message_received.connect(self.handle_message_received)
```

### 2. å¤šçº¿ç¨‹ç¼–ç¨‹

**çº¿ç¨‹æ¶æ„**:
- **ä¸»çº¿ç¨‹**: UI çº¿ç¨‹ï¼Œå¤„ç†ç”¨æˆ·äº¤äº’
- **NetworkCore çº¿ç¨‹**: UDP æ¥æ”¶å¾ªç¯
- **FileSender/FileReceiver çº¿ç¨‹**: æ–‡ä»¶ä¼ è¾“
- **CameraCaptureThread**: æ‘„åƒå¤´å¸§æ•è·

**æ³¨æ„äº‹é¡¹**:
- âœ… æ‰€æœ‰ UI æ“ä½œå¿…é¡»åœ¨ä¸»çº¿ç¨‹
- âœ… çº¿ç¨‹é—´é€šä¿¡ä½¿ç”¨ä¿¡å·æ§½
- âœ… ä½¿ç”¨ `QThread.wait()` ç­‰å¾…çº¿ç¨‹ç»“æŸ
- âœ… é¿å…å…±äº«å¯å˜çŠ¶æ€

### 3. è‡ªå®šä¹‰èµ„æºåè®®

**å®ç°åŸç†**:
```python
# æ¶ˆæ¯ä¸­åµŒå…¥: <img src="emoji:[1]" />
# QTextBrowser è°ƒç”¨ loadResource()
def loadResource(self, type, name: QUrl):
    if name.scheme() == 'emoji':
        # åŠ è½½ GIF æ–‡ä»¶
        path = self.emoji_manager.get_emoji_path(code)
        movie = QMovie(path)
        return movie
```

**ä¼˜åŠ¿**:
- æ— éœ€ä¿®æ”¹ HTML ç»“æ„
- å»¶è¿ŸåŠ è½½ï¼šåªåœ¨éœ€è¦æ—¶åŠ è½½ GIF
- æ˜“äºæ‰©å±•ï¼šå¯ä»¥æ·»åŠ å…¶ä»–èµ„æºç±»å‹

### 4. å†…å­˜ç®¡ç†ä¼˜åŒ–

**é—®é¢˜**: GIF åŠ¨ç”»å ç”¨å¤§é‡å†…å­˜

**è§£å†³æ–¹æ¡ˆ**:
1. **LRU ç¼“å­˜**: é™åˆ¶ç¼“å­˜æ•°é‡ï¼ˆ20 ä¸ªï¼‰
2. **æš‚åœæœºåˆ¶**: æ¨¡æ€å¯¹è¯æ¡†æ—¶æš‚åœåŠ¨ç”»
3. **æ¸…ç†æœºåˆ¶**: çª—å£å…³é—­æ—¶æ¸…ç†ç¼“å­˜

**ä»£ç ç¤ºä¾‹**:
```python
def clear_cache(self):
    """æ¸…ç†ç¼“å­˜ï¼Œé‡Šæ”¾å†…å­˜"""
    for movie in self.movie_cache.values():
        movie.stop()
        movie.deleteLater()
    self.movie_cache.clear()
```

### 5. ä¸»é¢˜é€‚é…

**å®ç°æ–¹å¼**: åŠ¨æ€æ ·å¼è¡¨

**ä»£ç ç¤ºä¾‹**:
```python
def set_window_style(self):
    if isDarkTheme():
        window_bg = "rgb(32, 32, 32)"
        text_color = "white"
    else:
        window_bg = "rgb(243, 243, 243)"
        text_color = "black"
    
    self.setStyleSheet(f"""
        ChatWindow {{
            background-color: {window_bg};
            color: {text_color};
        }}
    """)
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. ç½‘ç»œæ€§èƒ½ä¼˜åŒ–

**UDP æ¥æ”¶ä¼˜åŒ–**:
- è¶…æ—¶æœºåˆ¶ (`settimeout(1.0)`) å…è®¸å®šæœŸæ£€æŸ¥é€€å‡ºæ ‡å¿—
- ç¼“å†²åŒºå¤§å°ï¼š1024 å­—èŠ‚ï¼ˆè¶³å¤Ÿæ–‡æœ¬æ¶ˆæ¯ï¼‰

**æ–‡ä»¶ä¼ è¾“ä¼˜åŒ–**:
- å—å¤§å°ï¼š4096 å­—èŠ‚ï¼ˆå¹³è¡¡å†…å­˜å’Œæ€§èƒ½ï¼‰
- TCP è‡ªåŠ¨æµæ§ï¼Œæ— éœ€æ‰‹åŠ¨æ§åˆ¶

### 2. UI æ€§èƒ½ä¼˜åŒ–

**è¡¨æƒ…åŠ¨ç”»ä¼˜åŒ–**:
- LRU ç¼“å­˜é™åˆ¶å†…å­˜å ç”¨
- æš‚åœæœºåˆ¶å‡å°‘ CPU å ç”¨
- å¸§æ›´æ–°æ—¶åªæ›´æ–°å¿…è¦åŒºåŸŸ

**çª—å£æ¸²æŸ“ä¼˜åŒ–**:
- ä½¿ç”¨ `SmoothScrollBar` æä¾›æµç•…æ»šåŠ¨
- é¿å…é¢‘ç¹çš„ `update()` è°ƒç”¨
- ä½¿ç”¨ `setUpdatesEnabled(False)` æš‚åœæ›´æ–°

### 3. æ‘„åƒå¤´æ€§èƒ½ä¼˜åŒ–

**èµ„æºé™åˆ¶**:
- å¸§ç‡ï¼š15 FPSï¼ˆè¶³å¤Ÿé¢„è§ˆï¼‰
- åˆ†è¾¨ç‡ï¼š640x480ï¼ˆå¹³è¡¡è´¨é‡å’Œæ€§èƒ½ï¼‰
- JPEG å‹ç¼©ï¼š85% è´¨é‡ï¼ˆå‡å°æ–‡ä»¶å¤§å°ï¼‰

**çº¿ç¨‹ä¼˜åŒ–**:
- ç‹¬ç«‹çº¿ç¨‹æ•è·ï¼Œé¿å…é˜»å¡ UI
- ä½¿ç”¨ `msleep()` æ§åˆ¶å¸§ç‡
- åŠæ—¶é‡Šæ”¾æ‘„åƒå¤´èµ„æº

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: ä¸ºä»€ä¹ˆ UDP æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼Ÿ

**åŸå› **:
- UDP æ˜¯æ— è¿æ¥åè®®ï¼Œä¸ä¿è¯å¯é æ€§
- ç½‘ç»œæ‹¥å¡æ—¶å¯èƒ½ä¸¢åŒ…
- ç¼“å†²åŒºæ»¡æ—¶å¯èƒ½ä¸¢å¼ƒæ•°æ®åŒ…

**è§£å†³æ–¹æ¡ˆ**:
- å¯¹äºå…³é”®æ¶ˆæ¯ï¼ˆå¦‚æ–‡ä»¶ä¼ è¾“è¯·æ±‚ï¼‰ï¼Œä½¿ç”¨ TCP
- å¯ä»¥å®ç°é‡ä¼ æœºåˆ¶ï¼ˆå½“å‰ç‰ˆæœ¬æœªå®ç°ï¼‰
- æ¶ˆæ¯å›æ‰§æœºåˆ¶ç¡®è®¤é€è¾¾

### Q2: å¤šç”¨æˆ·åŒæ—¶å‘é€æ–‡ä»¶å¦‚ä½•å¤„ç†ï¼Ÿ

**å½“å‰å®ç°**:
- æ¯ä¸ªæ–‡ä»¶ä¼ è¾“ä½¿ç”¨ç‹¬ç«‹çš„ TCP è¿æ¥
- ä½¿ç”¨ `packet_no` æ ‡è¯†ä¸åŒçš„ä¼ è¾“è¯·æ±‚
- æ¥æ”¶æ–¹å¯ä»¥å¹¶è¡Œå¤„ç†å¤šä¸ªä¼ è¾“

**æ½œåœ¨é—®é¢˜**:
- å¤§é‡å¹¶å‘ä¼ è¾“å¯èƒ½å ç”¨è¿‡å¤šèµ„æº
- ç«¯å£å†²çªï¼ˆå·²è§£å†³ï¼šä½¿ç”¨éšæœºç«¯å£ï¼‰

### Q3: è¡¨æƒ… GIF å ç”¨å†…å­˜è¿‡å¤šï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**:
- LRU ç¼“å­˜é™åˆ¶ç¼“å­˜æ•°é‡
- çª—å£å…³é—­æ—¶æ¸…ç†ç¼“å­˜
- æ¨¡æ€å¯¹è¯æ¡†æ—¶æš‚åœåŠ¨ç”»

**è¿›ä¸€æ­¥ä¼˜åŒ–**:
- å¯ä»¥é™ä½ GIF åˆ†è¾¨ç‡
- ä½¿ç”¨é™æ€å›¾ç‰‡æ›¿ä»£éƒ¨åˆ† GIF
- å®ç°è¡¨æƒ…æ‡’åŠ è½½

### Q4: è·¨å¹³å°å…¼å®¹æ€§é—®é¢˜ï¼Ÿ

**å·²çŸ¥é—®é¢˜**:
- Windows: æ‘„åƒå¤´å¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
- Linux: éœ€è¦å®‰è£… `v4l2` é©±åŠ¨
- macOS: éœ€è¦æƒé™æˆæƒ

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨ OpenCV ç»Ÿä¸€æ¥å£
- é”™è¯¯å¤„ç†ï¼šæ•è·å¼‚å¸¸ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
- åŠŸèƒ½é™çº§ï¼šæ‘„åƒå¤´ä¸å¯ç”¨æ—¶éšè—æŒ‰é’®

### Q5: å¦‚ä½•æ‰©å±•æ–°åŠŸèƒ½ï¼Ÿ

**æ‰©å±•ç‚¹**:
1. **æ–°æ¶ˆæ¯ç±»å‹**: åœ¨ `protocol.py` æ·»åŠ å‘½ä»¤å¸¸é‡
2. **æ–° UI ç»„ä»¶**: åœ¨ `ui/components/` æ·»åŠ ç»„ä»¶
3. **æ–°åŠŸèƒ½æ¨¡å—**: åˆ›å»ºæ–°çš„æ¨¡å—æ–‡ä»¶

**ç¤ºä¾‹ï¼šæ·»åŠ è¯­éŸ³æ¶ˆæ¯**:
```python
# 1. æ·»åŠ åè®®å¸¸é‡
IPMSG_SEND_VOICE = 0x00000070

# 2. æ·»åŠ ç½‘ç»œå¤„ç†
elif mode == protocol.IPMSG_SEND_VOICE:
    self.voice_received.emit(msg, addr[0])

# 3. æ·»åŠ  UI ç»„ä»¶
# ui/components/voice_recorder.py
```

---

## æ€»ç»“

### é¡¹ç›®äº®ç‚¹

1. âœ… **ç°ä»£åŒ– UI**: Fluent Design é£æ ¼ï¼Œç”¨æˆ·ä½“éªŒä¼˜ç§€
2. âœ… **å®Œæ•´åŠŸèƒ½**: èŠå¤©ã€æ–‡ä»¶ä¼ è¾“ã€è¡¨æƒ…ã€æˆªå›¾ã€æ‘„åƒå¤´
3. âœ… **æ¶æ„æ¸…æ™°**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
4. âœ… **æ€§èƒ½ä¼˜åŒ–**: å¤šçº¿ç¨‹ã€ç¼“å­˜ã€èµ„æºç®¡ç†
5. âœ… **è·¨å¹³å°**: Windowsã€Linuxã€macOS ç»Ÿä¸€ä»£ç 

### æŠ€æœ¯æ”¶è·

1. **PyQt5 GUI å¼€å‘**: ä¿¡å·æ§½ã€å¤šçº¿ç¨‹ã€è‡ªå®šä¹‰æ§ä»¶
2. **ç½‘ç»œç¼–ç¨‹**: UDP/TCP æ··åˆæ¶æ„ã€åè®®è®¾è®¡
3. **æ€§èƒ½ä¼˜åŒ–**: å†…å­˜ç®¡ç†ã€ç¼“å­˜ç­–ç•¥ã€çº¿ç¨‹ä¼˜åŒ–
4. **è½¯ä»¶å·¥ç¨‹**: æ¨¡å—åŒ–è®¾è®¡ã€ä»£ç ç»„ç»‡ã€é”™è¯¯å¤„ç†

### å¯æ”¹è¿›æ–¹å‘

1. **æ¶ˆæ¯åŠ å¯†**: æ·»åŠ ç«¯åˆ°ç«¯åŠ å¯†ï¼ˆAESï¼‰
2. **æ¶ˆæ¯å†å²**: æ•°æ®åº“å­˜å‚¨èŠå¤©è®°å½•
3. **æ–‡ä»¶ä¼ è¾“è¿›åº¦**: æ˜¾ç¤ºä¼ è¾“è¿›åº¦æ¡
4. **è¯­éŸ³/è§†é¢‘é€šè¯**: WebRTC é›†æˆ
5. **æ¶ˆæ¯åŒæ­¥**: å¤šè®¾å¤‡æ¶ˆæ¯åŒæ­¥

---

## é™„å½•ï¼šé¢è¯•å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆé€‰æ‹© PyQt5 è€Œä¸æ˜¯å…¶ä»– GUI æ¡†æ¶ï¼Ÿ

**ç­”æ¡ˆè¦ç‚¹**:
1. **æˆç†Ÿç¨³å®š**: å†å²æ‚ ä¹…ï¼Œæ–‡æ¡£å®Œå–„
2. **è·¨å¹³å°**: ä¸€å¥—ä»£ç ï¼Œå¤šå¹³å°è¿è¡Œ
3. **åŠŸèƒ½ä¸°å¯Œ**: å†…ç½®ç½‘ç»œã€æ•°æ®åº“ç­‰æ¨¡å—
4. **æ€§èƒ½ä¼˜ç§€**: C++ åº•å±‚ï¼Œæ¥è¿‘åŸç”Ÿæ€§èƒ½
5. **Fluent Design**: PyQt-Fluent-Widgets æä¾›ç°ä»£åŒ– UI

### Q: UDP å’Œ TCP çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ

**ç­”æ¡ˆè¦ç‚¹**:
- **UDP**: ç”¨æˆ·å‘ç°ã€æ–‡æœ¬æ¶ˆæ¯ï¼ˆä½å»¶è¿Ÿï¼Œå¯å®¹å¿ä¸¢å¤±ï¼‰
- **TCP**: æ–‡ä»¶ä¼ è¾“ï¼ˆéœ€è¦å¯é æ€§ï¼‰
- **æ··åˆæ¶æ„**: å‘æŒ¥å„è‡ªä¼˜åŠ¿ï¼Œå¹³è¡¡æ€§èƒ½å’Œå¯é æ€§

### Q: å¤šçº¿ç¨‹å¦‚ä½•é¿å…ç«æ€æ¡ä»¶ï¼Ÿ

**ç­”æ¡ˆè¦ç‚¹**:
1. **ä¿¡å·æ§½æœºåˆ¶**: è‡ªåŠ¨å¤„ç†çº¿ç¨‹é—´é€šä¿¡
2. **é¿å…å…±äº«çŠ¶æ€**: æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹æ•°æ®
3. **ä½¿ç”¨é˜Ÿåˆ—**: å¦‚æœå¿…é¡»å…±äº«ï¼Œä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—
4. **é”æœºåˆ¶**: å¿…è¦æ—¶ä½¿ç”¨ `QMutex`ï¼ˆæœ¬é¡¹ç›®æœªä½¿ç”¨ï¼‰

### Q: å¦‚ä½•ä¼˜åŒ–å†…å­˜å ç”¨ï¼Ÿ

**ç­”æ¡ˆè¦ç‚¹**:
1. **LRU ç¼“å­˜**: é™åˆ¶è¡¨æƒ… GIF ç¼“å­˜æ•°é‡
2. **åŠæ—¶æ¸…ç†**: çª—å£å…³é—­æ—¶æ¸…ç†èµ„æº
3. **æš‚åœæœºåˆ¶**: éæ´»è·ƒæ—¶æš‚åœåŠ¨ç”»
4. **å»¶è¿ŸåŠ è½½**: åªåœ¨éœ€è¦æ—¶åŠ è½½èµ„æº

### Q: å¦‚ä½•ä¿è¯æ–‡ä»¶ä¼ è¾“çš„å¯é æ€§ï¼Ÿ

**ç­”æ¡ˆè¦ç‚¹**:
1. **TCP åè®®**: è‡ªåŠ¨é‡ä¼ ã€æµæ§ã€æœ‰åºæ€§
2. **æ–‡ä»¶æ ¡éªŒ**: å¯ä»¥æ·»åŠ  MD5 æ ¡éªŒï¼ˆå½“å‰æœªå®ç°ï¼‰
3. **é”™è¯¯å¤„ç†**: æ•è·å¼‚å¸¸ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
4. **è¶…æ—¶æœºåˆ¶**: è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ— é™ç­‰å¾…

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**ä½œè€…**: circLEMoon

