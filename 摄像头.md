**RK3566 Qt Multimedia 交叉编译调试记录**

- 目录
- 概述
- 方案探讨与前期验证
- 问题一：CMake 找不到 Qt5Multimedia
- 问题二：Qt 开发文件同步进 sysroot
- 问题三：rsync 权限拒绝
- 残留告警：History 方法缺少返回
- 运行时部署提示

### 目录
- 概述
- 方案探讨与前期验证
- 问题一：CMake 找不到 Qt5Multimedia
- 问题二：Qt 开发文件同步进 sysroot
- 问题三：rsync 权限拒绝
- 残留告警：History 方法缺少返回
- 运行时部署提示

### 概述
- 主机环境：WSL (Ubuntu 20.04) 交叉编译 Qt 5.12.8 应用到 RK3566。
- 初始症状：`cmake -S … -B build-rk3566` 失败，提示 `Qt5Multimedia` 未找到。
- 根因：sysroot 中缺少 ARM64 Qt Multimedia 的开发期元数据和库。
- 解决路径：启用多架构软件源、更新软件包索引、安装 `qtmultimedia5-dev:arm64` 及其依赖、将头文件/库/CMake/pkg-config 同步进 sysroot，重新执行 CMake/Ninja。
- 当前状态：配置与构建成功，仅保留历史代码的返回值警告；部署时需确保目标板拥有匹配的运行时 `.so`。

### 方案探讨与前期验证
**目标功能**  
- 在 FeiQChatroom 中加入摄像头预览对话框，允许用户选择设备并查看实时画面。  
- 维持 Qt Widgets 架构，引入 `QtMultimedia` 与 `QtMultimediaWidgets` 模块。

**关键知识点与决策**  
- Qt 版本锁定为 5.12.8：确认 `QCamera` 与 `QCameraViewfinder` 可用，并避免使用 Qt 6 API。  
- 运行期视频解码依赖 GStreamer，需确认目标板（RK3566）具备对应插件管线。  
- UI 方案：新建 `CameraPreviewDialog` 负责列出 `QCameraInfo::availableCameras()`、封装启动/停止逻辑；在 `ChatWindow` 加入摄像头按钮并管理对话框生命周期。  
- 构建层面：CMake 需 `find_package(Qt5 COMPONENTS Widgets Multimedia MultimediaWidgets REQUIRED)` 并链接新增源文件。  
- 交叉环境：沿用现有 `cmake/toolchains/rk3566.cmake`，强调 `CMAKE_PREFIX_PATH` 指向 sysroot 中的 Qt cmake 包。

**前置验证步骤**  
- 主机先做本机（x86_64）构建，确认 UI 和逻辑可运行，无摄像头硬件时仍完成渲染。  
- 检查 sysroot 内容：定位 `libQt5Network.so.5`、`libQt5Widgets.so.5` 等，确认基础 Qt 库齐全但缺少 Multimedia 对应的 cmake 与头文件。  
- 验证环境脚本：`env/setup-rk3566.sh` 正确导出 `RK3566_SYSROOT`、`RK3566_TOOLCHAIN` 并设置 `PKG_CONFIG_LIBDIR`。  
- 评估目标板：确认已有基础 Qt 运行库，只缺对开发期工具的支持；因此决定在 WSL 安装 `*-dev` 包后将文件同步到 sysroot，而无需在板端重复安装。

### 问题一：CMake 找不到 Qt5Multimedia
**症状**  
- 使用工具链文件执行 CMake 时，报错 `Could NOT find Qt5Multimedia`。  
- sysroot 内未出现相关的 `Qt5MultimediaConfig.cmake`。

**分析与验证**  
- 查看 WSL `/usr/lib/aarch64-linux-gnu`：存在运行库 `libQt5Multimedia.so.5`，但缺失 CMake 配置文件。  
- toolchain 文件 `CMAKE_PREFIX_PATH` 指向 `${RK3566_SYSROOT}/usr/lib/aarch64-linux-gnu/cmake`，该目录为空。

**解决方案**  
1. `sudo apt update` 刷新软件包索引。  
2. 安装 ARM64 开发包：`sudo apt install qtmultimedia5-dev:arm64 qml-module-qtmultimedia:arm64`。  
   - 自动拉取 Qt base dev、GStreamer、GTK 等依赖。  
   - 安装过程中出现 `Exec format error`（ARM 可执行无法在 x86_64 上运行），作为交叉环境可忽略。  
3. 检查 CMake 目录：`ls /usr/lib/aarch64-linux-gnu/cmake | grep Qt5`，已存在 `Qt5Multimedia` 等配置。  
4. 同步到 sysroot 后重新 CMake，配置顺利完成。

### 问题二：Qt 开发文件同步进 sysroot
**目标**  
- 将 WSL 上安装的 ARM64 Qt 开发文件复制到 `${RK3566_SYSROOT}`，供交叉编译使用。

**失败尝试**  
- 直接 `rsync -a` 未使用 sudo，报 `Operation not permitted`、`Permission denied`，无法创建目录或写入文件。

**成功流程**  
1. `source env/setup-rk3566.sh`，获取 `RK3566_SYSROOT` 等环境变量。  
2. 使用 sudo 同步：  
   - CMake 元数据  
     ```
     sudo rsync -a /usr/lib/aarch64-linux-gnu/cmake/Qt5* \
       $RK3566_SYSROOT/usr/lib/aarch64-linux-gnu/cmake/
     ```  
   - 共享库  
     ```
     sudo rsync -a /usr/lib/aarch64-linux-gnu/libQt5* \
       $RK3566_SYSROOT/usr/lib/aarch64-linux-gnu/
     ```  
   - 头文件  
     ```
     sudo rsync -a /usr/include/aarch64-linux-gnu/qt5/ \
       $RK3566_SYSROOT/usr/include/aarch64-linux-gnu/qt5/
     ```  
   - 插件/运行时目录  
     ```
     sudo rsync -a /usr/lib/aarch64-linux-gnu/qt5/ \
       $RK3566_SYSROOT/usr/lib/aarch64-linux-gnu/qt5/
     ```  
   - pkg-config  
     ```
     sudo rsync -a /usr/lib/aarch64-linux-gnu/pkgconfig/Qt5* \
       $RK3566_SYSROOT/usr/lib/aarch64-linux-gnu/pkgconfig/
     ```  
3. 再次运行  
   ```
   cmake -S cpp-chatroom -B build-rk3566 \
     -G Ninja \
     -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/rk3566.cmake \
     -DCMAKE_PREFIX_PATH=$RK3566_SYSROOT/usr/lib/aarch64-linux-gnu/cmake \
     -DCMAKE_BUILD_TYPE=Release
   ```  
   配置成功，随后 `cmake --build build-rk3566`，生成 `build-rk3566/bin/FeiQChatroom`。

### 问题三：rsync 权限拒绝
**触发原因**  
- sysroot 目录归属 root，普通用户无法新建目录、写入文件或保留时间戳。

**处理方式**  
- 先用 `sudo mkdir -p` 创建目标路径。  
- 以 sudo 运行 rsync，同步时不再产生权限错误。  
- 经验：维护 sysroot 时要么使用 sudo，要么调整目录所有权。

### 残留告警：History 方法缺少返回
**现象**  
```
../feiqlib/history.cpp:193:1: warning: no return statement in function returning non-void
../feiqlib/history.cpp:198:1: warning: no return statement in function returning non-void
```

**状态**  
- 属于既有代码问题，未与本轮调试相关。  
- 后续可在 `History::getFellow` 与 `History::findFellowId` 中添加合适的返回语句或改签名。

### 运行时部署提示
- `qtmultimedia5-dev:arm64` 等开发包仅用于交叉编译；运行时只需 `.so`。  
- 若目标板已有 `libQt5Multimedia.so.5` 等库，交叉编译出的可执行文件可直接运行。  
- 若担心版本不匹配，可将 sysroot 同步出的 `libQt5*.so*` 打包随应用一起部署。  
- 上板前建议：  
  - 主机查看依赖：`readelf -d build-rk3566/bin/FeiQChatroom | grep NEEDED`。  
  - 目标板执行：`ldd ./FeiQChatroom`，确保所有依赖库可解析。  
- 除非在板上再次编译，无需安装 `*-dev` 包。